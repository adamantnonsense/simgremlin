<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sims Notes!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base color variables for Light Mode (default) */
        :root {
            --bg-primary: #f8f9fa; /* Wikipedia's light gray background */
            --text-primary: #202122; /* Wikipedia's dark text */
            --link-color: #3366cc; /* Wikipedia's standard blue link */
            --link-hover-color: #204080; /* Darker blue on hover */
            --border-color: #a2a9b1; /* Wikipedia's light border gray */
            --card-bg: #ffffff; /* White card background */
            --header-bg: #eaecf0; /* Wikipedia's section header gray */
            --button-bg: #eaecf0; /* Light button background */
            --button-text: #202122; /* Dark text on buttons */
            --button-hover-bg: #e0e3e7; /* Slightly darker button on hover */
            --table-header-bg: #eaecf0; /* Table header background */
            --table-row-odd-bg: #fdfdfd; /* Very light for odd rows */
            --table-row-even-bg: #ffffff; /* White for even rows */
            --status-alive: #28a745; /* Green for alive */
            --status-dead: #dc3545; /* Red for dead */
            --sim-name-header-text: #202122; /* Dark text for sim name in header */
            --sim-title-header-text: #4d5156; /* Muted text for sim title in header */
            --highlight-active: #6c8ebf; /* A subtle highlight color for active elements */
            --personality-low-color: #e67c73; /* Reddish for low end */
            --personality-high-color: #72a6e6; /* Bluish for high end */
            --personality-balanced-color: #778899; /* Grey for balanced */
        }

        /* Dark Mode variables */
        body.dark-theme {
            --bg-primary: #1c1c1c; /* Dark gray background */
            --text-primary: #f0f0f0; /* Light text */
            --link-color: #64b5f6; /* Lighter blue link */
            --link-hover-color: #42a5f5; /* Slightly brighter blue on hover */
            --border-color: #444444; /* Darker border gray */
            --card-bg: #2d2d2d; /* Dark card background */
            --header-bg: #3c3c3c; /* Darker section header gray */
            --button-bg: #3c3c3c; /* Dark button background */
            --button-text: #f0f0f0; /* Light text on buttons */
            --button-hover-bg: #4f4f4f; /* Slightly lighter button on hover */
            --table-header-bg: #3c3c3c; /* Table header background */
            --table-row-odd-bg: #2d2d2d; /* Darker for odd rows */
            --table-row-even-bg: #2a2a2a; /* Even darker for even rows */
            --status-alive: #2ecc71; /* Brighter green for alive */
            --status-dead: #e74c3c; /* Brighter red for dead */
            --sim-name-header-text: #f0f0f0; /* Light text for sim name in header */
            --sim-title-header-text: #b0b0b0; /* Muted light text for sim title in header */
            --highlight-active: #81c784; /* A subtle highlight color for active elements */
            --personality-low-color: #cc524a; /* Darker red for low end */
            --personality-high-color: #4a8ed9; /* Darker blue for high end */
            --personality-balanced-color: #556677; /* Darker grey for balanced */
        }

        /* General Body and Text Styles */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 1.5rem;
            line-height: 1.6;
            box-sizing: border-box;
            min-height: 100vh; /* Ensure body takes full height for dark mode effect */
        }

        h1, h2, h3, h4 {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            color: var(--text-primary);
            font-weight: 600; /* Bolder headings */
            margin-bottom: 0.8rem;
        }

        /* Link Styling */
        a {
            color: var(--link-color);
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        a:hover {
            color: var(--link-hover-color);
        }

        /* Panels and Cards - Clean, flat look */
        .sleek-panel, .trading-card-redesign, .family-overview-section, .spreadsheet-container, .graveyard-section, .homeless-sims-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow for definition */
            border-radius: 4px; /* Slightly rounded corners */
            padding: 1.5rem;
            margin-bottom: 0;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }

        .sleek-panel:hover, .trading-card-redesign:hover, .family-overview-section:hover, .spreadsheet-container:hover, .graveyard-section:hover, .homeless-sims-section:hover {
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Specific header colors for sections */
        .sleek-panel h2, .sleek-panel h3, .sleek-panel h4,
        .family-overview-section h4,
        .graveyard-section h3,
        .homeless-sims-section h3,
        .notes-section h2 {
            color: var(--text-primary); /* Ensures headers are visible */
            border-bottom: 1px solid var(--border-color); /* Simple border bottom */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* World Header - Wikipedia style (simple, clean) */
        .world-header {
            background-color: var(--header-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 1.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem; /* Adjusted gap: Reduced from 0.75rem to 0.5rem */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .world-header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700; /* Bold */
        }

        @media (min-width: 768px) {
            .world-header h1 {
                font-size: 3.2rem;
            }
        }

        .world-header p {
            font-size: 1rem;
            color: var(--text-primary); /* Ensure contrast */
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: color 0.2s ease, background-color 0.2s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed; /* Fixed position */
            top: 1rem; /* 16px from top */
            right: 1rem; /* 16px from right */
            z-index: 100; /* Ensure it's above other content */
        }

        #themeToggle:hover {
            background-color: var(--button-hover-bg);
        }

        /* Scrollbar */
        .scrollable-list {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--card-bg);
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 2px solid var(--card-bg);
        }

        .scrollable-list::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 10px;
        }

        /* Families Sidebar and its content */
        .families-sidebar {
            /* flex-grow for vertical expansion */
            flex-grow: 1; /* Allow it to grow to fill space */
            overflow-y: auto; /* Enable scrolling if content overflows */
        }

        /* Family Item (unselected family rectangle) */
        .family-item {
            background-color: #eaecf0; /* Light grey background */
            border: 1px solid var(--border-color);
            box-shadow: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            padding: 0.7rem;
            margin-bottom: 0.8rem;
            color: #202122; /* Black text */
            border-radius: 4px;
        }

        /* Dark mode override for unselected family item */
        body.dark-theme .family-item {
            background-color: #1A2B4C; /* Darker blue background */
            color: #ffffff; /* White text */
        }

        .family-item h3 {
            color: inherit; /* Inherit color from parent (.family-item) */
            font-size: 1.25rem;
            font-weight: 600;
        }

        .family-item:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            transform: none; /* No translation */
        }

        /* Dark mode override for unselected family item on hover */
        body.dark-theme .family-item:hover {
            background-color: #0F1A2D; /* Even darker blue on hover */
            color: #ffffff;
        }

        /* Selected Family Item (blue family rectangle) */
        .family-item.selected-family {
            background-color: #3366cc; /* Blue background */
            border-color: #204080; /* Darker blue border for contrast */
            color: #ffffff; /* White text */
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            transform: none; /* No scale or rotation */
        }

        /* Dark mode override for selected family item */
        body.dark-theme .family-item.selected-family {
            background-color: #3465cc; /* Changed to 3465cc for dark mode selected family */
            color: #ffffff; /* White text */
            border-color: #0F1A2D; /* A slightly lighter border than background for subtle definition */
        }

        .family-item + .family-item {
            margin-top: 1rem;
        }

        .family-item .expand-icon {
            transition: transform 0.3s ease;
        }

        .family-item.selected-family .expand-icon {
            transform: rotate(90deg);
        }

        /* Sims List */
        .sims-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0.5rem;
        }

        .sims-list.expanded {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        /* Sim Button (individual sim button - unselected) */
        .sim-button {
            background-color: #ffffff; /* White background in oval */
            color: #202122; /* Black text */
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            padding: 0.8rem 1.5rem;
            margin-bottom: 0.8rem;
            border-radius: 4px; /* Still a rectangle, but the request mentioned "oval" visually, can make it rounded */
            text-align: left;
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: none;
        }

        /* Dark mode override for unselected sim button */
        body.dark-theme .sim-button {
            background-color: #ffffff; /* White background */
            color: #202122; /* Black text */
        }

        .sim-button:last-child {
            margin-bottom: 0;
        }

        .sim-button:hover {
            background-color: var(--button-hover-bg);
            color: var(--text-primary); /* Keep text primary color on hover */
            transform: translateX(4px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        /* Selected Sim Button (clicked on sim - blue background button) */
        .sim-button.selected-sim {
            background-color: #3366cc; /* Blue background button */
            font-weight: 600;
            color: #ffffff; /* White text */
            border-color: #204080; /* Darker blue border for contrast */
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            transform: none; /* No scale or rotation */
        }

        /* Dark mode override for selected sim button */
        body.dark-theme .sim-button.selected-sim {
            background-color: #3366cc; /* Blue background button */
            color: #ffffff; /* White text */
        }

        /* Sim Details Card */
        .trading-card-redesign {
            padding: 1.8rem;
            transform: none; /* No rotation */
        }

        .trading-card-redesign:hover {
            transform: translateY(-2px);
        }

        .card-header-redesign {
            background-color: var(--header-bg); /* Solid background */
            color: var(--sim-name-header-text); /* Ensure contrast */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            padding: 1rem 1.5rem; /* Adjusted padding */
            margin: -1.8rem -1.8rem 1.5rem -1.8rem;
            position: relative;
            z-index: 2;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .card-header-redesign h2 {
            color: var(--sim-name-header-text);
            font-weight: 700;
        }

        .card-header-redesign .sim-name-display-redesign {
            color: var(--sim-name-header-text);
            font-size: 2.2rem;
            font-weight: 700;
        }

        .card-header-redesign .sim-title-display {
            color: var(--sim-title-header-text);
            font-style: normal;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .card-content-redesign {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .card-image-section-redesign {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio (height / width * 100) */
            margin-bottom: 1.2rem;
            box-shadow: none;
            transform: none;
            overflow: hidden;
            position: relative;
        }

        .card-image-section-redesign img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: 2px;
        }

        .section-block-style {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            margin-top: 1.2rem;
            border-radius: 4px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .section-block-style:first-of-type {
            margin-top: 0;
        }

        .section-block-style h4 {
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.4rem;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .section-block-style h4 .sim-stat-icon {
            color: var(--link-color);
            margin-right: 0.5rem;
        }

        .sim-bio-box-redesign p, .notes-section p {
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
        }

        .sim-quote-box p {
            color: var(--text-primary);
            font-size: 1rem;
        }

        .sim-quote-box span {
            color: var(--text-primary);
        }

        .sim-stat-icon {
            color: var(--link-color);
        }

        .sim-stat-label-redesign {
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .sim-stat-value-redesign {
            color: var(--text-primary);
            font-size: 0.95rem;
            white-space: normal;
            word-break: break-word;
            overflow-wrap: break-word;
            display: inline-block;
            max-width: calc(100% - 60px);
            vertical-align: top;
            line-height: 1.3;
        }

        .sim-stat-item {
            margin-bottom: 0.4rem;
        }

        /* Spacing for Key Details and Bio */
        .details-and-skills-grid {
            margin-top: 1.8rem;
        }

        /* Style for clickable partner names */
        .partner-link {
            cursor: pointer;
            color: var(--link-color);
            text-decoration: underline;
            font-weight: normal;
        }

        .partner-link:hover {
            color: var(--link-hover-color);
        }

        .status-alive { color: var(--status-alive); font-weight: bold; }
        .status-dead { color: var(--status-dead); font-weight: bold; }

        /* New styles for the skills list */
        .sim-skills-list {
            gap: 0.6rem;
            padding: 0.4rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .sim-skills-list-item {
            font-size: 1rem;
            color: var(--text-primary);
            padding: 0.2rem 0.4rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .sim-skills-list-item-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .sim-skills-list-item-value {
            font-weight: 600;
            color: var(--link-color);
        }

        .sim-trait-item-redesign {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
            border-radius: 4px;
            padding: 0.3rem 0.7rem;
            font-weight: 500;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .hobbies-list li {
            color: var(--text-primary);
            font-size: 1rem;
            list-style: disc;
            margin-left: 1.25rem;
        }

        .hobbies-list li::before {
            content: none;
        }

        /* Age Icons Container */
        .sim-age-icons-container {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            padding: 0.5rem 0;
            margin-bottom: 1.2rem;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            border-radius: 4px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .age-icon {
            font-size: 1.5rem;
            padding: 0;
            border-radius: 50%;
            background-color: var(--button-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            box-shadow: none;
            width: 2em;
            height: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .age-icon:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--link-color);
            transform: scale(1.05);
        }

        .age-icon.active-age-icon {
            background-color: var(--highlight-active);
            color: var(--text-primary);
            border-color: var(--link-color);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            transform: scale(1.1);
            animation: none;
        }

        /* Personality Display */
        .personality-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            font-size: 1rem;
        }

        /* Adjustments for the new format */
        .personality-item-label {
            flex-grow: 1;
            text-align: left;
            color: var(--text-primary);
            font-weight: 500;
        }

        .personality-item-value {
            font-weight: bold;
            padding-left: 0.5rem;
            color: var(--link-color);
        }

        /* Highlight for personality traits on the value */
        .personality-item-value.low {
            color: var(--personality-low-color);
        }

        .personality-item-value.high {
            color: var(--personality-high-color);
        }

        .personality-item-value.balanced {
            color: var(--personality-balanced-color);
        }

        /* Family Overview Section */
        .family-overview-section h4 {
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .family-overview-section h4 .fas.fa-home {
            margin-right: 0.4rem;
            color: var(--link-color);
        }

        .family-overview-section h4 .family-name-in-header {
            color: var(--text-primary);
        }

        .family-overview-section .family-bio-detail, .family-overview-section .family-bio-text-content {
            color: var(--text-primary);
        }

        .family-overview-section .family-bio-detail {
            font-size: 1rem;
            margin-bottom: 0.8rem;
            line-height: 1.4;
        }

        .family-overview-section .family-bio-detail .detail-value {
            color: var(--text-primary);
            font-weight: 500;
            display: inline-block;
            margin-left: 0.25rem;
        }

        .family-overview-section .family-bio-text-content {
            margin-top: 1.5rem;
        }

        .family-overview-section .family-bio-text-content h5 {
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
            font-size: 1.15rem;
        }

        .family-overview-section .family-bio-text-content p {
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Spreadsheet */
        .spreadsheet-container {
            padding-top: 1rem;
            transform: none;
        }

        .spreadsheet-container:hover {
            transform: translateY(-2px);
        }

        .sims-table th, .sims-table td {
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: normal;
        }

        .sims-table th {
            background-color: var(--table-header-bg);
            color: var(--text-primary);
            border-bottom: 2px solid var(--link-color);
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 0.8rem;
            white-space: nowrap;
            text-align: left;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .sims-table tbody tr:nth-child(odd) {
            background-color: var(--table-row-odd-bg);
        }

        .sims-table tbody tr:nth-child(even) {
            background-color: var(--table-row-even-bg);
        }

        .sims-table tbody tr:hover {
            background-color: var(--button-hover-bg);
        }

        .sims-table td strong {
            color: var(--status-alive);
        }

        .sims-table .clickable-sim-name {
            color: var(--link-color);
            font-weight: normal;
            text-decoration: underline;
        }

        .sims-table .clickable-sim-name:hover {
            color: var(--link-hover-color);
        }

        /* Sortable table headers */
        .sortable-th {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }

        .sortable-th .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            color: var(--text-primary);
            transition: color 0.2s ease;
        }

        .sortable-th:hover .sort-icon {
            color: var(--link-color);
        }

        .sortable-th.asc .sort-icon::before {
            content: "\f0d8";
        }

        .sortable-th.desc .sort-icon::before {
            content: "\f0d7";
        }

        .sortable-th:not(.asc):not(.desc) .sort-icon::before {
            content: "\f0dc";
            opacity: 0.5;
        }

        /* Stories */
        #storyDisplayContent {
            padding: 1.5rem;
            transform: none;
        }

        #storyDisplayContent:hover {
            transform: translateY(-2px);
        }

        #storyDisplayContent h2 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        #storyDisplayContent p {
            color: var(--text-primary);
        }

        .story-list-in-card {
            gap: 0.8rem;
        }

        .story-list-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            font-size: 1rem;
            border-radius: 4px;
            box-shadow: none;
            transition: all 0.2s ease-in-out;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transform: none;
        }

        .story-list-item:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            transform: none;
        }

        .story-list-item.selected-story-in-card {
            background-color: var(--highlight-active);
            border-color: var(--link-color);
            color: var(--text-primary);
            font-weight: 600;
            transform: none;
        }

        .story-list-item span {
            font-weight: 500;
        }

        /* Single Story Content */
        .story-single-content-in-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1.5rem;
            position: relative;
            overflow: visible;
            transform: none;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .story-single-content-in-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .story-back-button {
            background-color: var(--button-bg);
            border: 1px solid var(--border-color);
            color: var(--button-text);
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: none;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .story-back-button:hover {
            background-color: var(--button-hover-bg);
            filter: none;
            transform: translateY(-1px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .story-image-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 1rem;
            box-shadow: none;
            transform: none;
            overflow: hidden;
            position: relative;
            padding-bottom: 56.25%;
        }

        .story-image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        #storyContent {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* Graveyard Specific Styling */
        .graveyard-section {
            padding: 1.5rem;
            transform: none;
        }

        .graveyard-section:hover {
            transform: translateY(-2px);
        }

        .graveyard-section h3 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 0.8rem;
        }

        .graveyard-section h3 .sim-stat-icon {
            margin-right: 0.6rem;
            color: var(--status-dead);
        }

        .graveyard-section p {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1.2rem;
        }

        .graveyard-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: none;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
            padding: 0.7rem 1rem;
            cursor: pointer;
            transform: none;
        }

        .graveyard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            background-color: var(--button-hover-bg);
        }

        .graveyard-item .graveyard-icon {
            font-size: 2.2rem;
            color: var(--status-dead);
        }

        .graveyard-item h5 {
            color: var(--text-primary);
            font-weight: 500;
            margin: 0;
            line-height: 1.1;
        }

        .graveyard-item p {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.1;
        }

        /* Homeless Sims Section */
        .homeless-sims-section {
            padding: 1.5rem;
            transform: none;
        }

        .homeless-sims-section:hover {
            transform: translateY(-2px);
        }

        .homeless-sims-section h3 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 0.8rem;
        }

        .homeless-sims-section h3 .sim-stat-icon {
            margin-right: 0.6rem;
            color: var(--link-color);
        }

        .homeless-sim-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: none;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
            padding: 0.7rem 1rem;
            cursor: pointer;
            transform: none;
        }

        .homeless-sim-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            background-color: var(--button-hover-bg);
        }

        .homeless-sim-item h5 {
            color: var(--text-primary);
            font-weight: 500;
            margin: 0;
            line-height: 1.1;
        }

        .homeless-sim-item p {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.1;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .main-layout-grid {
                display: flex;
                flex-direction: row;
                gap: 2rem;
            }

            .families-sidebar {
                flex-basis: 280px;
                flex-shrink: 0;
                flex-grow: 0;
            }

            .main-content-area {
                flex-grow: 1;
            }
        }

        /* Static Navigation Bar - Flat, tab-like buttons */
        .static-nav-bar {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-top: 0;
            margin-bottom: 0;
            flex-wrap: wrap;
            transform: none;
        }

        .static-nav-bar button {
            background-color: var(--button-bg);
            color: var(--button-text);
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            white-space: nowrap;
            border: 1px solid var(--border-color);
        }

        .static-nav-bar button:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            background-color: var(--button-hover-bg);
        }

        /* Specific colors for nav buttons (adjusted for general scheme) */
        #showNeighborhoodStoriesBtn { background-color: var(--button-bg); }
        #showNeighborhoodStoriesBtn:hover { background-color: var(--button-hover-bg); }
        #showSpreadsheetBtn { background-color: var(--button-bg); }
        #showSpreadsheetBtn:hover { background-color: var(--button-hover-bg); }
        #showGraveyardBtn { background-color: var(--button-bg); }
        #showGraveyardBtn:hover { background-color: var(--button-hover-bg); }
        #showNotesBtn { background-color: var(--button-bg); }
        #showNotesBtn:hover { background-color: var(--button-hover-bg); }
        #showHomelessSimsBtn { background-color: var(--button-bg); }
        #showHomelessSimsBtn:hover { background-color: var(--button-hover-bg); }

        /* Mobile adjustments for nav bar */
        @media (max-width: 767px) {
            .static-nav-bar {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                padding: 0.8rem;
                gap: 0.5rem;
                border-radius: 8px;
                max-width: calc(100% - 2rem);
                margin-left: auto;
                margin-right: auto;
            }

            .static-nav-bar button {
                width: auto;
                flex-grow: 1;
                min-width: fit-content;
            }
        }

        /* Image Modal Styles */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .image-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* Ensure pointer-events are off when hidden */
        .image-modal-overlay:not(.visible) {
            pointer-events: none;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .image-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            z-index: 1001;
        }

        .image-modal-close:hover {
            background-color: var(--status-dead);
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <button id="themeToggle" class="fixed top-4 right-4 z-100">
        <i class="fas fa-sun"></i> <!-- Sun icon for light mode, will change to moon in dark mode -->
    </button>
    <div class="main-layout-grid flex flex-col md:flex-row gap-6 max-w-5xl mx-auto">
        <div class="families-sidebar sleek-panel p-6 md:w-72 md:flex-shrink-0 flex flex-col">
            <h2 class="text-2xl font-bold mb-4 flex items-center justify-between relative z-20">
                Families <i class="fas fa-users"></i>
            </h2>
            <div id="familyList" class="scrollable-list flex-grow relative z-20">
                <!-- Family list will be dynamically populated here -->
            </div>
        </div>
        <div class="main-content-area flex flex-col gap-3 flex-grow">
            <div class="world-header p-6 rounded-lg text-center flex-shrink-0">
                <h1 id="worldNameDisplay" class="text-4xl md:text-5xl font-extrabold text-center mb-2"></h1>
                <p id="worldDescriptionDisplay" class="text-lg md:text-xl"></p>
            </div>
            
            <div id="staticNavBar" class="static-nav-bar">
                <button id="showNeighborhoodStoriesBtn" class="px-5 py-2 rounded-md font-bold">Neighborhood Stories</button>
                <button id="showSpreadsheetBtn" class="px-5 py-2 rounded-md font-bold">All Sims</button>
                <button id="showHomelessSimsBtn" class="px-5 py-2 rounded-md font-bold">Homeless Sims</button>
                <button id="showGraveyardBtn" class="px-5 py-2 rounded-md font-bold">Graveyard</button>
                <button id="showNotesBtn" class="px-5 py-2 rounded-md font-bold">Notes</button>
            </div>
            <div id="contentDisplayArea" class="flex-grow flex flex-col">
                <div id="simDetailsCard" class="trading-card-redesign hidden flex-col flex-grow">
                    <div class="card-header-redesign relative">
                        <h2 id="simNameDisplay" class="sim-name-display-redesign text-3xl md:text-4xl font-extrabold mb-1"></h2>
                        <p id="simTitleDisplay" class="sim-title-display text-lg md:text-2xl font-medium"></p>
                    </div>
                    <div class="card-content-redesign flex flex-col flex-grow">
                        <div class="card-image-section-redesign rounded-md" onclick="openImageModal(document.getElementById('simImage').src)">
                            <img id="simImage" src="https://via.placeholder.co/400x225/3182CE/C2D0E6?text=Sim+Image" alt="Sim Image" class="w-full h-full object-cover rounded-md">
                        </div>
                        <div id="simAgeIconsContainer" class="sim-age-icons-container">
                        </div>
                        <div class="sim-bio-box-redesign section-block-style">
                            <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-book sim-stat-icon"></i> Bio</h4>
                            <p id="simBioText" class="text-base leading-relaxed"></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow details-and-skills-grid">
                            <div class="sim-details-section section-block-style">
                                <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-info-circle sim-stat-icon"></i> Key Details</h4>
                                <div class="sim-details-list flex flex-col gap-2">
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Age:</span> <span id="simAge" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Gender:</span> <span id="simGender" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Status:</span> <span id="simStatus" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Occult Status:</span> <span id="simOccultStatus" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Career:</span> <span id="simCareer" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Aspiration:</span> <span id="simAspiration" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Zodiac:</span> <span id="simZodiac" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Partner:</span> <span id="simPartners" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Parents:</span> <span id="simParents" class="sim-stat-value-redesign"></span></div>
                                    <div class="sim-stat-item"><span class="sim-stat-label-redesign">Children:</span> <span id="simChildren" class="sim-stat-value-redesign"></span></div>
                                </div>
                            </div>
                            <div class="sim-skills-section section-block-style">
                                <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-star sim-stat-icon"></i> Skills</h4>
                                <div id="simSkillsList" class="sim-skills-list">
                                </div>
                            </div>
                            <div id="simPersonalitySection" class="sim-personality-section section-block-style col-span-1 md:col-span-2">
                                <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-smile sim-stat-icon"></i> Personality</h4>
                                <div id="simPersonalityList" class="flex flex-col gap-2">
                                </div>
                            </div>
                            <div class="sim-traits-section section-block-style col-span-1 md:col-span-2">
                                <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-tags sim-stat-icon"></i> Traits</h4>
                                <div id="simTraitList" class="sim-trait-list-redesign flex flex-wrap gap-2">
                                </div>
                            </div>
                        </div>
                        <div class="sim-hobbies-section section-block-style">
                            <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-gamepad sim-stat-icon"></i> Hobbies & Interests</h4>
                            <ul id="simHobbiesList" class="hobbies-list list-none pl-0">
                            </ul>
                        </div>
                        <div class="notes-section section-block-style">
                            <h4 class="text-xl font-semibold mb-3 flex items-center"><i class="fas fa-clipboard sim-stat-icon"></i> Notes</h4>
                            <p id="simNotes" class="text-base leading-relaxed"></p>
                        </div>
                    </div>
                </div>
                <div id="familyOverviewContent" class="family-overview-section hidden flex-col flex-grow">
                    <h4 class="mb-4 flex items-center relative z-20">
                        <i class="fas fa-home mr-2"></i> <span id="familyOverviewTitleName" class="family-name-in-header"></span>
                    </h4>
                    <p class="family-bio-detail mb-3 relative z-20">
                        <span class="font-normal">Location:<br></span> <span id="familyLocation" class="detail-value"></span>
                    </p>
                    <p class="family-bio-detail mb-3 relative z-20">
                        <span class="font-normal">Number of Members:<br></span> <span id="familyMemberCount" class="detail-value"></span>
                    </p>
                    <p class="family-bio-detail mb-3 relative z-20">
                        <span class="font-normal">Funds:<br></span> <span id="familyFunds" class="detail-value"></span>
                    </p>
                    <div class="family-bio-text-content mt-6 relative z-20">
                        <h5 class="text-xl font-semibold mb-2">Biography:</h5>
                        <p id="familyBiography"></p>
                    </div>
                </div>
                <div id="spreadsheetView" class="spreadsheet-container collapsed hidden flex-col flex-grow">
                    <div class="collapsible-content scrollable max-h-0 overflow-hidden transition-all duration-400 ease-in-out relative z-20">
                        <div class="overflow-x-auto">
                            <table class="sims-table min-w-full bg-white bg-opacity-70 rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 sortable-th" data-sort="name">Name<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="py-3 px-4 sortable-th" data-sort="family">Family<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="py-3 px-4 sortable-th" data-sort="age">Age<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="py-3 px-4 sortable-th" data-sort="status">Status<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="py-3 px-4 sortable-th" data-sort="career">Career<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="py-3 px-4 sortable-th" data-sort="aspiration">Aspiration<i class="fas fa-sort sort-icon"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="simsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="storyDisplayContent" class="sleek-panel hidden flex-col flex-grow">
                    <h2 class="text-2xl font-bold mb-4 flex items-center relative z-20">
                        Neighborhood Stories
                    </h2>
                    <div id="storyListContainer" class="">
                        <div id="storyList" class="story-list-in-card flex flex-col scrollable-list max-h-96">
                        </div>
                    </div>
                    <div id="singleStoryContainer" class="hidden">
                        <button class="story-back-button px-4 py-2 rounded-md" onclick="showStoryList()">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Stories
                        </button>
                        <div class="story-image-container" onclick="openImageModal(document.getElementById('storyImage').src)">
                            <img id="storyImage" src="https://placehold.co/400x225/EF5350/E2E8F0?text=Story%20Image" alt="Story Image" class="w-full h-full object-cover rounded-md">
                        </div>
                        <div id="storyContent" class="story-single-content-in-card p-4 rounded-md text-base leading-relaxed">
                        </div>
                    </div>
                </div>
                <div id="graveyardSection" class="graveyard-section hidden flex-col flex-grow">
                    <h3 class="text-2xl font-extrabold mb-4 flex items-center relative z-20"><i class="fas fa-cross sim-stat-icon mr-2"></i> The Graveyard</h3>
                    <p class="text-center text-secondary text-lg mb-4 relative z-20">Here lie the dearly departed Sims of Newcrest.</p>
                    <div id="graveyardGrid" class="graveyard-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 relative z-20">
                    </div>
                </div>
                <div id="homelessSimsSection" class="homeless-sims-section hidden flex-col flex-grow">
                    <h3 class="text-2xl font-extrabold mb-4 flex items-center relative z-20"><i class="fas fa-house-damage sim-stat-icon mr-2"></i> Homeless Sims</h3>
                    <p class="text-center text-secondary text-lg mb-4 relative z-20">These Sims are currently without a permanent home.</p>
                    <div id="homelessSimsGrid" class="homeless-sims-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 relative z-20">
                    </div>
                </div>
                <div id="notesSection" class="sleek-panel hidden flex-col flex-grow">
                    <h2 class="text-2xl font-bold mb-4 flex items-center relative z-20">
                        <i class="fas fa-book-open mr-2"></i> Collected Notes
                    </h2>
                    <div id="notesContent" class="relative z-20">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="imageModal" class="image-modal-overlay">
        <div class="image-modal-content">
            <img id="modalImage" src="" alt="Full size image">
            <button class="image-modal-close" onclick="closeImageModal()">X</button>
        </div>
    </div>
    <script>
        // --- CONFIGURATION: REPLACE THESE WITH YOUR GOOGLE SHEET DETAILS ---
        const GOOGLE_SHEET_ID = '2PACX-1vSs1l3tUbLZpKfZCUxSkdYYsRcneV_PsoF7yPLJ3YdZr_tsVSOo3qcH4idIjwmx-f4U7rMb7_nBDSuV'; // Your main Google Sheet ID

        // GIDs for each specific sheet within the spreadsheet
        const WORLD_INFO_GID = '1046330091';
        const SIM_BIO_GID = '522782907';
        const FAMILY_BIO_GID = '75505924';
        const STORIES_GID = '1540825772';
        // -------------------------------------------------------------------

        // Default data: Used only as fallback if CSV loading fails for a specific sheet.
        // All primary data for families and sims will now come ONLY from the Google Sheets.
        const defaultSimData = {
            "worldInfo": {
                name: "Newcrest (Default Data)",
                description: "This is a demo of your Sims' notes. Connect your Google Sheets to load your own data!"
            },
            "homelessSims": [] // This will be populated from Sim Bio CSV or remain empty
        };

        const defaultNeighborhoodStories = []; // This will be populated from Stories CSV

        // Global data store for Sims and Families (will be populated by CSV)
        let simData = {}; // Initialize as empty, will be populated by loadAllData
        let neighborhoodStories = [];

        let currentSelectedFamily = null;
        let currentSelectedSim = null;
        let collectedSimNotes = new Map();

        // Global state for spreadsheet sorting
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Define lifeStagesIcons for the age icons
        const lifeStagesIcons = {
            "Baby": " ", "Toddler": " ", "Child": " ", "Teen": " ",
            "Young Adult": " ", "Adult": " ", "Elder": " "
        };

        // --- Helper Functions (defined before they are used in initializeDisplay and CSV parsing) ---

        // Function to hide all content sections
        function hideAllContentSections() {
            document.getElementById('simDetailsCard').classList.add('hidden');
            document.getElementById('simDetailsCard').classList.remove('flex');
            document.getElementById('familyOverviewContent').classList.add('hidden');
            document.getElementById('familyOverviewContent').classList.remove('flex');
            document.getElementById('spreadsheetView').classList.add('hidden');
            document.getElementById('spreadsheetView').classList.add('collapsed');
            const spreadsheetCollapsibleContent = document.getElementById('spreadsheetView').querySelector('.collapsible-content');
            if (spreadsheetCollapsibleContent) {
                spreadsheetCollapsibleContent.classList.add('collapsed');
                spreadsheetCollapsibleContent.style.maxHeight = '0';
            }
            document.getElementById('storyDisplayContent').classList.add('hidden');
            document.getElementById('storyDisplayContent').classList.remove('flex');
            document.getElementById('graveyardSection').classList.add('hidden');
            document.getElementById('graveyardSection').classList.remove('flex');
            document.getElementById('homelessSimsSection').classList.add('hidden');
            document.getElementById('homelessSimsSection').classList.remove('flex');
            document.getElementById('notesSection').classList.add('hidden');
            document.getElementById('notesSection').classList.remove('flex');
        }

        // Utility to find a sim by name across all families and homeless sims
        function findSimByName(simName) {
            for (const familyKey in simData) {
                if (familyKey === "worldInfo" || familyKey === "homelessSims") continue; // Skip worldInfo and homelessSims for family iteration
                const familyMembers = simData[familyKey].members;
                if (familyMembers) {
                    const foundSim = familyMembers.find(sim => sim.name === simName);
                    if (foundSim) {
                        return foundSim;
                    }
                }
            }
            // Check homeless sims separately
            if (simData.homelessSims) {
                const foundHomelessSim = simData.homelessSims.find(sim => sim.name === simName);
                if (foundHomelessSim) {
                    return foundHomelessSim;
                }
            }
            return null;
        }

        function updateSimImageForAge(sim, age) {
            const simImageElement = document.getElementById('simImage');
            const encodedSimName = encodeURIComponent(sim.name);
            const encodedAge = encodeURIComponent(age);
            let selectedImageUrl = '';

            // 1. Check if there's a specific image URL for this age stage in sim.images (from CSV columns like Image_Baby)
            // The sim.images object stores these if parsed from CSV.
            if (sim.images && sim.images[age]) {
                selectedImageUrl = sim.images[age];
            }
            // 2. Fallback to the primary 'image' URL from CSV (the 'Image' column) if no specific age image is found
            if (!selectedImageUrl && sim.image) {
                selectedImageUrl = sim.image;
            }
            // 3. Fallback to a placeholder image if no image URL is found at all for the sim or specific age
            if (!selectedImageUrl) {
                selectedImageUrl = `https://placehold.co/400x225/${encodeURIComponent('DCDCDC')}/${encodeURIComponent('202122')}?text=${encodedSimName}%20-%20${encodedAge}`;
            }
            
            simImageElement.src = selectedImageUrl;

            // Update active state for age icons
            const ageIcons = document.querySelectorAll('#simAgeIconsContainer .age-icon');
            ageIcons.forEach(icon => {
                if (icon.dataset.age === age) {
                    icon.classList.add('active-age-icon');
                } else {
                    icon.classList.remove('active-age-icon');
                }
            });
        }

        function displaySimDetails(sim) {
            if (!sim) {
                console.error("Attempted to display sim details for an undefined sim object.");
                hideAllContentSections();
                return;
            }

            const simDetailsCard = document.getElementById('simDetailsCard');
            simDetailsCard.classList.remove('hidden');
            simDetailsCard.classList.add('flex');

            document.getElementById('simNameDisplay').textContent = sim.name;
            document.getElementById('simTitleDisplay').textContent = sim.title || 'N/A';
            
            // Set initial image based on the sim's default age from CSV
            updateSimImageForAge(sim, sim.age || 'Young Adult');

            document.getElementById('simBioText').textContent = sim.bio || 'No biography provided.';
            document.getElementById('simAge').textContent = sim.age || 'N/A';
            document.getElementById('simGender').textContent = sim.gender || 'N/A';

            const simStatusElement = document.getElementById('simStatus');
            simStatusElement.textContent = sim.status || 'Unknown';
            simStatusElement.className = '';
            simStatusElement.classList.add((sim.status && sim.status.toLowerCase() === 'alive') ? 'status-alive' : 'status-dead');

            document.getElementById('simOccultStatus').textContent = sim.occultStatus || 'Human';
            document.getElementById('simCareer').textContent = `${sim.career || 'Unemployed'} (Level ${sim.careerLevel || 'N/A'})`;
            document.getElementById('simAspiration').textContent = sim.aspiration || 'N/A';
            document.getElementById('simZodiac').textContent = sim.zodiac || 'N/A';

            function populateRelationship(elementId, relationshipArray) {
                const element = document.getElementById(elementId);
                element.innerHTML = '';
                if (relationshipArray && relationshipArray.length > 0) {
                    relationshipArray.forEach((name, index) => {
                        const link = document.createElement('span');
                        link.classList.add('partner-link');
                        link.textContent = name;
                        link.onclick = (event) => {
                            event.stopPropagation();
                            selectSim(name);
                        };
                        element.appendChild(link);
                        if (index < relationshipArray.length - 1) {
                            element.append(', ');
                        }
                    });
                } else {
                    element.textContent = 'None';
                }
            }
            populateRelationship('simPartners', sim.partners);
            populateRelationship('simParents', sim.parents);
            populateRelationship('simChildren', sim.children);

            const traitsList = document.getElementById('simTraitList');
            traitsList.innerHTML = '';
            if (sim.traits && sim.traits.length > 0) {
                sim.traits.forEach(trait => {
                    const span = document.createElement('span');
                    span.classList.add('sim-trait-item-redesign');
                    span.textContent = trait;
                    traitsList.appendChild(span);
                });
            } else {
                traitsList.innerHTML = '<span class="text-gray-500">No traits listed.</span>';
            }
            
            const hobbiesList = document.getElementById('simHobbiesList');
            hobbiesList.innerHTML = '';
            if (sim.hobbies && sim.hobbies.length > 0) {
                sim.hobbies.forEach(hobby => {
                    const li = document.createElement('li');
                    li.textContent = hobby;
                    hobbiesList.appendChild(li);
                });
            } else {
                hobbiesList.innerHTML = '<li class="text-gray-500">No hobbies listed.</li>';
            }
            
            document.getElementById('simNotes').textContent = sim.notes || 'No specific notes yet.';

            if (sim.notes && sim.notes.trim() !== '') {
                collectedSimNotes.set(sim.name, sim.notes);
            }

            const simAgeIconsContainer = document.getElementById('simAgeIconsContainer');
            simAgeIconsContainer.innerHTML = '';
            const lifeStagesForIcons = ["Baby", "Toddler", "Child", "Teen", "Young Adult", "Adult", "Elder"];
            lifeStagesForIcons.forEach(stage => {
                const iconSpan = document.createElement('span');
                iconSpan.classList.add('age-icon');
                iconSpan.textContent = lifeStagesIcons[stage] || '';
                iconSpan.dataset.age = stage;
                iconSpan.onclick = () => updateSimImageForAge(sim, stage);
                simAgeIconsContainer.appendChild(iconSpan);
            });
            // Re-apply active state based on the current sim's age after all icons are created
            updateSimImageForAge(sim, sim.age || 'Young Adult');


            const simSkillsList = document.getElementById('simSkillsList');
            simSkillsList.innerHTML = '';
            if (sim.skills && Object.keys(sim.skills).length > 0) {
                for (const skillName in sim.skills) {
                    const skillLevel = sim.skills[skillName];
                    const skillItem = document.createElement('div');
                    skillItem.classList.add('sim-skills-list-item');
                    skillItem.innerHTML = `
                        <span class="sim-skills-list-item-label relative z-20">${skillName}:</span>
                        <span class="sim-skills-list-item-value relative z-20">${skillLevel}/10</span>
                    `;
                    simSkillsList.appendChild(skillItem);
                }
            } else {
                simSkillsList.innerHTML = '<p class="text-gray-500">No skills listed.</p>';
            }

            const simPersonalitySection = document.getElementById('simPersonalitySection');
            const simPersonalityList = document.getElementById('simPersonalityList');
            simPersonalityList.innerHTML = '';

            if (!sim.personality || Object.keys(sim.personality).length === 0) {
                simPersonalitySection.classList.add('hidden');
            } else {
                simPersonalitySection.classList.remove('hidden');
                const personalityMapping = {
                    "sloppyNeat": { label: "Sloppy - Neat" },
                    "shyOutgoing": { label: "Shy - Outgoing" },
                    "lazyActive": { label: "Lazy - Active" },
                    "seriousPlayful": { label: "Serious - Playful" },
                    "grouchyNice": { label: "Grouchy - Nice" }
                };

                for (const key in personalityMapping) {
                    if (sim.personality.hasOwnProperty(key)) {
                        const value = sim.personality[key];
                        const label = personalityMapping[key].label;
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('personality-item');
                        let valueClass = 'personality-item-value';
                        if (value >= 1 && value <= 4) {
                            valueClass += ' low';
                        } else if (value >= 7 && value <= 10) {
                            valueClass += ' high';
                        } else {
                            valueClass += ' balanced';
                        }
                        itemDiv.innerHTML = `
                            <span class="personality-item-label relative z-20">${label}:</span>
                            <span class="${valueClass} relative z-20">${value}</span>
                        `;
                        simPersonalityList.appendChild(itemDiv);
                    }
                }
            }
        }

        function displayFamilyOverview(familyNameKey) {
            const family = simData[familyNameKey];
            if (family && family.familyBio) {
                document.getElementById('familyOverviewContent').classList.remove('hidden');
                document.getElementById('familyOverviewContent').classList.add('flex');

                document.getElementById('familyOverviewTitleName').textContent = family.familyBio.name || 'N/A';
                document.getElementById('familyLocation').textContent = family.familyBio.location || 'N/A';
                document.getElementById('familyMemberCount').textContent = family.members ? family.members.length : 0;
                document.getElementById('familyFunds').textContent = family.familyBio.funds || '$0';
                document.getElementById('familyBiography').textContent = family.familyBio.biography || 'No biography provided.';
            } else {
                document.getElementById('familyOverviewContent').classList.add('hidden');
                document.getElementById('familyOverviewContent').classList.remove('flex');
            }
        }

        function getAllSims() {
            let allSims = [];
            for (const familyKey in simData) {
                if (familyKey === "worldInfo") continue; // Skip worldInfo
                if (familyKey === "homelessSims") {
                    if (simData[familyKey]) { // Ensure homelessSims array exists
                        simData[familyKey].forEach(sim => {
                            allSims.push({ ...sim, family: 'Homeless' });
                        });
                    }
                } else {
                    const family = simData[familyKey];
                    if (family && family.members) {
                        family.members.forEach(sim => {
                            allSims.push({ ...sim, family: family.familyBio.name.replace(' Family', '') });
                        });
                    }
                }
            }
            return allSims;
        }

        function populateSpreadsheet(sortColumn = currentSortColumn, sortDirection = currentSortDirection) {
            const simsTableBody = document.getElementById('simsTableBody');
            simsTableBody.innerHTML = '';
            let allSims = getAllSims();

            if (allSims.length === 0) {
                simsTableBody.innerHTML = '<tr><td colspan="6" class="py-2 px-4 text-center text-gray-500">No Sims found.</td></tr>';
                return;
            }

            currentSortColumn = sortColumn;
            currentSortDirection = sortDirection;

            if (sortColumn) {
                allSims.sort((a, b) => {
                    let valA = a[sortColumn];
                    let valB = b[sortColumn];

                    if (sortColumn === 'age') {
                        const ageOrder = {
                            "Baby": 0, "Toddler": 1, "Child": 2, "Teen": 3,
                            "Young Adult": 4, "Adult": 5, "Elder": 6
                        };
                        valA = ageOrder[valA] !== undefined ? ageOrder[valA] : 99;
                        valB = ageOrder[valB] !== undefined ? ageOrder[valB] : 99;
                    } else if (sortColumn === 'status') {
                        valA = valA === 'Alive' ? 0 : 1;
                        valB = valB === 'Alive' ? 0 : 1;
                    } else {
                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                    }

                    if (valA < valB) {
                        return sortDirection === 'asc' ? -1 : 1;
                    }
                    if (valA > valB) {
                        return sortDirection === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }

            allSims.forEach(sim => {
                const row = document.createElement('tr');
                simsTableBody.appendChild(row);
                row.innerHTML = `
                    <td class="py-2 px-4"><span class="clickable-sim-name" onclick="selectSim('${sim.name}')">${sim.name || 'N/A'}</span></td>
                    <td class="py-2 px-4">${sim.family || 'N/A'}</td>
                    <td class="py-2 px-4">${sim.age || 'N/A'}</td>
                    <td class="py-2 px-4"><span class="${(sim.status && sim.status.toLowerCase() === 'alive') ? 'status-alive' : 'status-dead'}">${sim.status || 'N/A'}</span></td>
                    <td class="py-2 px-4">${sim.career || 'N/A'} (Level ${sim.careerLevel || 'N/A'})</td>
                    <td class="py-2 px-4">${sim.aspiration || 'N/A'}</td>
                `;
            });

            document.querySelectorAll('.sortable-th').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === sortColumn) {
                    th.classList.add(sortDirection);
                }
            });
        }

        function showSpreadsheet() {
            hideAllContentSections();
            document.getElementById('spreadsheetView').classList.remove('hidden');
            document.getElementById('spreadsheetView').classList.remove('collapsed');
            document.getElementById('spreadsheetView').classList.add('flex');
            document.getElementById('spreadsheetView').querySelector('.collapsible-content').classList.remove('collapsed');
            requestAnimationFrame(() => {
                document.getElementById('spreadsheetView').querySelector('.collapsible-content').style.maxHeight = document.getElementById('spreadsheetView').querySelector('.collapsible-content').scrollHeight + 'px';
            });
            populateSpreadsheet(currentSortColumn, currentSortDirection);
        }

        function displayNeighborhoodStories() {
            hideAllContentSections();
            const storyDisplayContent = document.getElementById('storyDisplayContent');
            const storyList = document.getElementById('storyList');
            const storyListContainer = document.getElementById('storyListContainer');
            const singleStoryContainer = document.getElementById('singleStoryContainer');

            storyDisplayContent.classList.remove('hidden');
            storyDisplayContent.classList.add('flex');
            storyListContainer.classList.remove('hidden');
            singleStoryContainer.classList.add('hidden');
            storyList.innerHTML = '';

            if (neighborhoodStories && neighborhoodStories.length > 0) {
                neighborhoodStories.forEach((story) => {
                    const storyItem = document.createElement('div');
                    storyItem.classList.add('story-list-item', 'px-4', 'py-2', 'rounded-md', 'shadow-sm', 'cursor-pointer');
                    storyItem.innerHTML = `<span class="relative z-20">${story.headline}</span>`;
                    storyItem.onclick = () => showSingleStory(story);
                    storyList.appendChild(storyItem);
                });
            } else {
                storyList.innerHTML = '<p class="text-center text-muted-dark relative z-20">No neighborhood stories yet!</p>';
            }

            storyList.classList.add('max-h-96', 'scrollable-list');
        }

        function showSingleStory(story) {
            document.getElementById('storyListContainer').classList.add('hidden');
            document.getElementById('singleStoryContainer').classList.remove('hidden');
            const storyImageContainer = document.querySelector('#singleStoryContainer .story-image-container');
            storyImageContainer.onclick = () => openImageModal(document.getElementById('storyImage').src);
            const storyImageElement = document.getElementById('storyImage');
            
            const encodedHeadlineForImage = encodeURIComponent(story.headline);
            storyImageElement.src = `https://placehold.co/400x225/${encodeURIComponent('DCC29F')}/${encodeURIComponent('3A3A3A')}?text=Story%20Image%0A${encodedHeadlineForImage.substring(0, 30)}...`;
            storyImageElement.alt = story.headline;
            storyImageElement.classList.remove('hidden');
            
            document.getElementById('storyContent').textContent = story.content;
            
            document.getElementById('storyList').classList.remove('max-h-96', 'scrollable-list');
        }

        function showStoryList() {
            document.getElementById('storyListContainer').classList.remove('hidden');
            document.getElementById('singleStoryContainer').classList.add('hidden');
            document.getElementById('storyList').classList.add('max-h-96', 'scrollable-list');
        }

        function populateGraveyard() {
            const graveyardGrid = document.getElementById('graveyardGrid');
            graveyardGrid.innerHTML = '';
            let deadSimsFound = false;

            const allSims = getAllSims();

            allSims.forEach(sim => {
                if (sim.status && sim.status.toLowerCase() === "dead") {
                    deadSimsFound = true;
                    const graveyardItem = document.createElement('div');
                    graveyardItem.classList.add('graveyard-item');
                    graveyardItem.onclick = () => selectSim(sim.name);
                    graveyardItem.innerHTML = `
                        <div class="graveyard-icon relative z-20"> </div>
                        <div class="relative z-20">
                            <h5>${sim.name || 'N/A'}</h5>
                            <p>${sim.title || 'N/A'}</p>
                        </div>
                    `;
                    graveyardGrid.appendChild(graveyardItem);
                }
            });

            if (!deadSimsFound) {
                graveyardGrid.innerHTML = '<p class="col-span-full text-center text-muted-dark relative z-20">No Sims in the graveyard... yet.</p>';
            }
        }

        function showGraveyard() {
            hideAllContentSections();
            document.getElementById('graveyardSection').classList.remove('hidden');
            document.getElementById('graveyardSection').classList.add('flex');
            populateGraveyard();
        }

        function populateHomelessSims() {
            const homelessSimsGrid = document.getElementById('homelessSimsGrid');
            homelessSimsGrid.innerHTML = '';

            if (simData.homelessSims && simData.homelessSims.length > 0) {
                simData.homelessSims.forEach(sim => {
                    const homelessSimItem = document.createElement('div');
                    homelessSimItem.classList.add('homeless-sim-item');
                    homelessSimItem.onclick = () => selectSim(sim.name);
                    homelessSimItem.innerHTML = `
                        <div class="graveyard-icon sim-stat-icon relative z-20"> </div>
                        <div class="relative z-20">
                            <h5>${sim.name || 'N/A'}</h5>
                            <p>${sim.title || 'N/A'}</p>
                        </div>
                    `;
                    homelessSimsGrid.appendChild(homelessSimItem);
                });
            } else {
                homelessSimsGrid.innerHTML = '<p class="col-span-full text-center text-muted-dark relative z-20">No homeless Sims found.</p>';
            }
        }

        function showHomelessSims() {
            hideAllContentSections();
            document.getElementById('homelessSimsSection').classList.remove('hidden');
            document.getElementById('homelessSimsSection').classList.add('flex');
            populateHomelessSims();
        }

        function displayNotesSection() {
            hideAllContentSections();
            const notesSection = document.getElementById('notesSection');
            notesSection.classList.remove('hidden');
            notesSection.classList.add('flex');
            const notesContentDiv = document.getElementById('notesContent');
            notesContentDiv.innerHTML = '';

            if (collectedSimNotes.size === 0) {
                notesContentDiv.innerHTML = '<p class="text-center text-muted-dark relative z-20">No notes collected yet. Visit a Sim\'s biography to add their notes here!</p>';
            } else {
                collectedSimNotes.forEach((note, simName) => {
                    const noteEntry = document.createElement('div');
                    noteEntry.classList.add('section-block-style', 'relative', 'z-20', 'mb-4');
                    noteEntry.innerHTML = `
                        <h5 class="text-xl font-semibold mb-2 text-accent-brown relative z-20">${simName}'s Notes:</h5>
                        <p class="text-base leading-relaxed relative z-20">${note}</p>
                    `;
                    notesContentDiv.appendChild(noteEntry);
                });
            }
        }

        // Image Modal Functions
        function openImageModal(imgSrc) {
            document.getElementById('modalImage').src = imgSrc;
            document.getElementById('imageModal').classList.add('visible');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('visible');
            document.getElementById('modalImage').src = '';
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });

        // Theme Toggle Logic
        function applyTheme(theme) {
            const body = document.body;
            const toggleIcon = document.getElementById('themeToggle').querySelector('i');
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-theme');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'light') {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        }

        // --- CSV Parsing Functions for each specific sheet ---

        // Generic CSV parsing helper
        function parseCsvGeneric(csvText, expectedHeaders) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length <= 1) {
                return [];
            }

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const rowData = {};
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    rowData[header.trim()] = value;
                });
                data.push(rowData);
            }
            return data;
        }

        async function fetchWorldInfoCsv() {
            const csvUrl = `https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEET_ID}/pub?gid=${WORLD_INFO_GID}&single=true&output=csv`;
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for World Info Sheet (GID: ${WORLD_INFO_GID})`);
                const csvText = await response.text();
                const data = parseCsvGeneric(csvText, ['World Name', 'World Description']);
                if (data.length > 0) {
                    return {
                        name: data[0]['World Name'] || defaultSimData.worldInfo.name,
                        description: data[0]['World Description'] || defaultSimData.worldInfo.description
                    };
                }
            } catch (error) {
                console.error("Error loading World Information CSV:", error);
            }
            return defaultSimData.worldInfo;
        }

        async function fetchFamilyBiographiesCsv() {
            const csvUrl = `https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEET_ID}/pub?gid=${FAMILY_BIO_GID}&single=true&output=csv`;
            const families = {};
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for Family Bio Sheet (GID: ${FAMILY_BIO_GID})`);
                const csvText = await response.text();
                const data = parseCsvGeneric(csvText, ['Family Name', 'Family Location', 'Family Funds', 'Family Biography']);
                
                data.forEach(row => {
                    if (row['Family Name']) {
                        const familyNameKey = row['Family Name'].replace(/ /g, '').replace(/'/g, '');
                        families[familyNameKey] = {
                            familyBio: {
                                name: row['Family Name'],
                                location: row['Family Location'] || 'Unknown',
                                funds: row['Family Funds'] || '$0',
                                biography: row['Family Biography'] || 'No biography provided.',
                                memberCount: 0
                            },
                            members: []
                        };
                    }
                });
            } catch (error) {
                console.error("Error loading Family Biography CSV:", error);
            }
            return families;
        }

        async function fetchSimBiographiesCsv(existingFamilies) {
            const csvUrl = `https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEET_ID}/pub?gid=${SIM_BIO_GID}&single=true&output=csv`;
            const sims = {};
            const homelessSimsList = [];

            // Initialize sims object with existing family bios structure
            for(const key in existingFamilies) {
                sims[key] = { ...existingFamilies[key], members: [] }; // Deep copy existing family bios
            }

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for Sim Bio Sheet (GID: ${SIM_BIO_GID})`);
                const csvText = await response.text();
                const data = parseCsvGeneric(csvText, [
                    'Name', 'Title', 'Image', 'Bio', 'Age', 'Gender', 'Status', 'Occult Status',
                    'Career', 'Career Level', 'Aspiration', 'Zodiac', 'Partners', 'Parents',
                    'Children', 'Skills', 'Traits', 'Hobbies', 'Notes', 'Personality', 'Family Name'
                ]);

                data.forEach(row => {
                    const sim = {
                        name: row['Name'],
                        title: row['Title'],
                        image: row['Image'],
                        bio: row['Bio'],
                        age: row['Age'],
                        gender: row['Gender'],
                        status: row['Status'],
                        occultStatus: row['Occult Status'] || 'Human',
                        career: row['Career'],
                        careerLevel: parseInt(row['Career Level'], 10) || 'N/A',
                        aspiration: row['Aspiration'],
                        zodiac: row['Zodiac'],
                        partners: row['Partners'] ? row['Partners'].split(';').map(s => s.trim()).filter(s => s) : [],
                        parents: row['Parents'] ? row['Parents'].split(';').map(s => s.trim()).filter(s => s) : [],
                        children: row['Children'] ? row['Children'].split(';').map(s => s.trim()).filter(s => s) : [],
                        skills: {},
                        traits: row['Traits'] ? row['Traits'].split(';').map(s => s.trim()).filter(s => s) : [],
                        hobbies: row['Hobbies'] ? row['Hobbies'].split(';').map(s => s.trim()).filter(s => s) : [],
                        notes: row['Notes'],
                        personality: {}
                    };

                    if (row['Skills']) {
                        row['Skills'].split(';').forEach(skillPair => {
                            const [skillName, skillLevel] = skillPair.split(':').map(s => s.trim());
                            if (skillName && skillLevel) sim.skills[skillName] = parseInt(skillLevel, 10);
                        });
                    }

                    if (row['Personality']) {
                        row['Personality'].split(';').forEach(traitPair => {
                            const [traitName, traitValue] = traitPair.split(':').map(s => s.trim());
                            if (traitName && traitValue) sim.personality[traitName] = parseInt(traitValue, 10);
                        });
                    }

                    // Collect other age specific images if they exist in CSV (e.g., "Image_Baby")
                    sim.images = sim.images || {}; // Ensure sim.images object exists
                    ['Baby', 'Toddler', 'Child', 'Teen', 'Young Adult', 'Adult', 'Elder'].forEach(stage => {
                        const colName = 'Image_' + stage.replace(' ', ''); // e.g., 'Image_YoungAdult'
                        if (row[colName]) {
                            sim.images[stage] = row[colName];
                        }
                    });

                    if (sim.name) {
                        if (row['Family Name'] && row['Family Name'].toLowerCase() === 'homeless') {
                            homelessSimsList.push(sim);
                        } else {
                            const familyNameKey = row['Family Name'] ? row['Family Name'].replace(/ /g, '').replace(/'/g, '') : 'UnknownFamily';
                            if (!sims[familyNameKey]) {
                                // This case should ideally be handled by fetchFamilyBiographiesCsv first.
                                // If a sim lists a family not defined in the family sheet, create a basic placeholder.
                                console.warn(`Sim '${sim.name}' belongs to family '${row['Family Name']}' not found in Family Biography Sheet. Creating a placeholder entry.`);
                                sims[familyNameKey] = {
                                    familyBio: {
                                        name: row['Family Name'] || 'Unknown Family',
                                        location: 'Unknown',
                                        funds: '$0',
                                        biography: 'No biography provided in Family Sheet.',
                                        memberCount: 0
                                    },
                                    members: []
                                };
                            }
                            sims[familyNameKey].members.push(sim);
                        }
                    }
                });

                // Update member counts after all sims are added
                for (const familyKey in sims) {
                    if (sims.hasOwnProperty(familyKey) && sims[familyKey].members) {
                        sims[familyKey].familyBio.memberCount = sims[familyKey].members.length;
                    }
                }

            } catch (error) {
                console.error("Error loading Sim Biography CSV:", error);
                // Return existing families and default homeless sims if this sheet fails
                return { families: existingFamilies, homelessSims: defaultSimData.homelessSims };
            }
            return { families: sims, homelessSims: homelessSimsList };
        }

        async function fetchNeighborhoodStoriesCsv() {
            const csvUrl = `https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEET_ID}/pub?gid=${STORIES_GID}&single=true&output=csv`;
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for Stories Sheet (GID: ${STORIES_GID})`);
                const csvText = await response.text();
                const data = parseCsvGeneric(csvText, ['Story Headline', 'Story Content']);
                return data.map(row => ({
                    headline: row['Story Headline'],
                    content: row['Story Content']
                })).filter(story => story.headline && story.content); // Filter out empty stories
            } catch (error) {
                console.error("Error loading Neighborhood Stories CSV:", error);
            }
            return defaultNeighborhoodStories; // Return default if fetch or parse fails
        }

        // --- Main Data Loading Function ---
        async function loadAllData() {
            let loadingError = false;
            let errorMessage = "Errors occurred while loading data. Showing default demo data.";

            // Step 1: Initialize global simData based on default structure (empty families)
            simData = { ...defaultSimData };

            // Step 2: Load World Info
            try {
                simData.worldInfo = await fetchWorldInfoCsv();
                document.getElementById('worldNameDisplay').textContent = simData.worldInfo.name;
                document.getElementById('worldDescriptionDisplay').textContent = simData.worldInfo.description;
            } catch (e) {
                loadingError = true;
                errorMessage += `\n- World Info: ${e.message}`;
            }

            // Step 3: Load Family Biographies (these define the family structures)
            let loadedFamilies = {};
            try {
                loadedFamilies = await fetchFamilyBiographiesCsv();
            } catch (e) {
                loadingError = true;
                errorMessage += `\n- Family Bios: ${e.message}`;
            }

            // Step 4: Load Sim Biographies (these populate the members of the families)
            let loadedSimsAndHomeless = { families: {}, homelessSims: [] };
            try {
                // Pass loadedFamilies to ensure sims are added to existing family structures
                loadedSimsAndHomeless = await fetchSimBiographiesCsv(loadedFamilies);
                
                // Now, merge the loaded sim data into the global simData structure
                // This ensures that simData only contains families explicitly defined in the CSVs
                simData = {
                    "worldInfo": simData.worldInfo, // Keep worldInfo
                    ...loadedSimsAndHomeless.families, // Add all families with their members
                    "homelessSims": loadedSimsAndHomeless.homelessSims // Add homeless sims
                };

                // Sort family keys for consistent display in the sidebar
                const sortedFamilyKeys = Object.keys(simData)
                    .filter(k => k !== "worldInfo" && k !== "homelessSims")
                    .sort((a, b) => {
                        // Ensure familyBio.name exists for comparison
                        const nameA = (simData[a] && simData[a].familyBio && simData[a].familyBio.name) ? simData[a].familyBio.name : '';
                        const nameB = (simData[b] && simData[b].familyBio && simData[b].familyBio.name) ? simData[b].familyBio.name : '';
                        return nameA.localeCompare(nameB);
                    });

                // Reconstruct simData with sorted families and homeless sims at the end
                const orderedSimData = {
                    "worldInfo": simData.worldInfo,
                    ...sortedFamilyKeys.reduce((obj, key) => {
                        obj[key] = simData[key];
                        return obj;
                    }, {}),
                    "homelessSims": simData.homelessSims
                };
                simData = orderedSimData;

            } catch (e) {
                loadingError = true;
                errorMessage += `\n- Sim Bios: ${e.message}`;
            }

            // Step 5: Load Neighborhood Stories
            try {
                neighborhoodStories = await fetchNeighborhoodStoriesCsv();
            } catch (e) {
                loadingError = true;
                errorMessage += `\n- Stories: ${e.message}`;
            }

            // Log final parsed data (for debugging)
            console.log("Final simData after loading:", simData);
            console.log("Final neighborhoodStories after loading:", neighborhoodStories);

            if (loadingError) {
                const contentDisplayArea = document.getElementById('contentDisplayArea');
                contentDisplayArea.innerHTML = `<div class="sleek-panel p-6 text-center text-red-600">
                    <h3 class="text-xl font-bold mb-2">Error Loading Some Data from Google Sheets</h3>
                    <p class="mb-4">The site is currently showing default demo data or incomplete data because some sheets failed to load.</p>
                    <p>Please ensure all your Google Sheets are:</p>
                    <ul class="list-disc list-inside text-left mx-auto max-w-sm mt-4">
                        <li>Correctly published to the web as CSV (File > Share > Publish to web > Select Sheet > Format: Comma-separated values (.csv) > Publish).</li>
                        <li>The GIDs in the script's configuration match the GIDs in your sheet URLs.</li>
                        <li>There are no typos in the sheet headers.</li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-500">Details: ${errorMessage}</p>
                </div>`;
            }

            // Always initialize display regardless of loading success
            initializeDisplay();
        }

        // Initialize display and event listeners
        function initializeDisplay() {
            // Set initial world info based on loaded data (or default)
            document.getElementById('worldNameDisplay').textContent = simData.worldInfo.name;
            document.getElementById('worldDescriptionDisplay').textContent = simData.worldInfo.description;

            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            document.getElementById('showNeighborhoodStoriesBtn').addEventListener('click', displayNeighborhoodStories);
            document.getElementById('showSpreadsheetBtn').addEventListener('click', showSpreadsheet);
            document.getElementById('showHomelessSimsBtn').addEventListener('click', showHomelessSims);
            document.getElementById('showGraveyardBtn').addEventListener('click', showGraveyard);
            document.getElementById('showNotesBtn').addEventListener('click', displayNotesSection);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            document.querySelectorAll('.sortable-th').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    let direction = 'asc';
                    if (currentSortColumn === column && currentSortDirection === 'asc') {
                        direction = 'desc';
                    }
                    populateSpreadsheet(column, direction);
                });
            });

            updateFamilyList();
            // Determine initial view: if families exist, show first family overview, else show spreadsheet
            const familyKeys = Object.keys(simData).filter(k => k !== "worldInfo" && k !== "homelessSims");
            if (familyKeys.length > 0) {
                currentSelectedFamily = familyKeys[0]; // Select the first family by default
                displayFamilyOverview(currentSelectedFamily);
            } else {
                showSpreadsheet(); // Fallback to spreadsheet if no families are found
            }
        }

        // Call loadAllData automatically on window load
        window.onload = loadAllData;

        // Function to update the family list in the sidebar (kept at the end for logical flow)
        function updateFamilyList() {
            const familyListElement = document.getElementById('familyList');
            familyListElement.innerHTML = '';

            const familyNames = Object.keys(simData).filter(k => k !== "worldInfo" && k !== "homelessSims");
            if (familyNames.length === 0) {
                familyListElement.innerHTML = '<p class="text-center text-muted-dark relative z-20">No families found.</p>';
                return;
            }

            familyNames.forEach(familyNameKey => {
                const family = simData[familyNameKey];
                const isSelectedFamily = familyNameKey === currentSelectedFamily;
                const familyItemClass = isSelectedFamily ? 'family-item selected-family' : 'family-item';
                const displayFamilyName = family.familyBio.name.replace(' Family', '');

                let familyHtml = `
                    <div class="${familyItemClass} p-2 rounded-md shadow-sm flex items-center justify-between" onclick="selectFamily('${familyNameKey}')">
                        <h3 class="text-lg font-semibold relative z-20">${displayFamilyName}</h3>
                        <i class="fas fa-chevron-right expand-icon text-sm relative z-20"></i>
                    </div>
                    <div class="sims-list ml-4 mt-1 ${isSelectedFamily ? 'expanded' : ''}">
                `;

                if (family.members && family.members.length > 0) {
                    // Show all members, but differentiate by status
                    // Sort members alphabetically by name
                    family.members.sort((a, b) => a.name.localeCompare(b.name));
                    
                    family.members.forEach(sim => {
                        const isSelectedSim = isSelectedFamily && currentSelectedSim && sim.name === currentSelectedSim.name;
                        let simButtonClass = isSelectedSim ? 'sim-button selected-sim' : 'sim-button';
                        // Add classes for dead sims: grey out and strike-through
                        let simStatusTextClass = (sim.status && sim.status.toLowerCase() === 'alive') ? '' : 'text-gray-500 line-through';
                        
                        familyHtml += `<button class="${simButtonClass} px-3 py-1 rounded-full text-sm block w-full text-left" onclick="selectSim('${sim.name}')">
                            <span class="relative z-20 ${simStatusTextClass}">${sim.name}</span>
                        </button>`;
                    });
                } else {
                    familyHtml += `<p class="px-3 py-1 text-sm text-gray-500">No members listed.</p>`;
                }
                familyHtml += `</div>`;
                familyListElement.innerHTML += familyHtml;
            });

            // Ensure the currently selected family's expand icon and max-height are correct on initial load or list update
            const selectedFamilyElement = document.querySelector(`.family-item.selected-family`);
            if (selectedFamilyElement) {
                const expandIcon = selectedFamilyElement.querySelector('.expand-icon');
                if (expandIcon) {
                    expandIcon.style.transform = 'rotate(90deg)';
                }
                const simsList = selectedFamilyElement.nextElementSibling;
                if (simsList && simsList.classList.contains('sims-list')) {
                    simsList.style.maxHeight = simsList.scrollHeight + 'px';
                }
            }
        }

        function selectFamily(familyNameKey) {
            const prevSelectedFamilyElement = document.querySelector(`.family-item.selected-family`);
            if (prevSelectedFamilyElement) {
                const prevSimsList = prevSelectedFamilyElement.nextElementSibling;
                if (prevSimsList && prevSimsList.classList.contains('sims-list')) {
                    prevSimsList.classList.remove('expanded');
                    prevSimsList.style.maxHeight = '0';
                    prevSelectedFamilyElement.classList.remove('selected-family');
                    const prevExpandIcon = prevSelectedFamilyElement.querySelector('.expand-icon');
                    if(prevExpandIcon) prevExpandIcon.style.transform = 'rotate(0deg)';
                }
            }

            if (familyNameKey === currentSelectedFamily && document.querySelector(`.family-item[onclick="selectFamily('${familyNameKey}')"]`).classList.contains('selected-family')) {
                currentSelectedFamily = null;
                hideAllContentSections();
                return;
            }

            currentSelectedFamily = familyNameKey;
            currentSelectedSim = null;

            const newSelectedFamilyElement = document.querySelector(`.family-item[onclick="selectFamily('${familyNameKey}')"]`);
            if (newSelectedFamilyElement) {
                const newSimsList = newSelectedFamilyElement.nextElementSibling;
                if (newSimsList && newSimsList.classList.contains('sims-list')) {
                    newSimsList.classList.add('expanded');
                    newSimsList.style.maxHeight = newSimsList.scrollHeight + 'px';
                    newSelectedFamilyElement.classList.add('selected-family');
                    const newExpandIcon = newSelectedFamilyElement.querySelector('.expand-icon');
                    if(newExpandIcon) newExpandIcon.style.transform = 'rotate(90deg)';
                }
            }
            updateFamilyList();
            hideAllContentSections();
            displayFamilyOverview(familyNameKey);
        }

        function selectSim(simName) {
            let foundSim = findSimByName(simName);
            
            if (!foundSim) {
                console.error(`Sim with name '${simName}' not found.`);
                hideAllContentSections();
                return;
            }
            
            currentSelectedSim = foundSim;
            // Find the family key of the selected sim to ensure correct highlighting in the sidebar
            for (const familyKey in simData) {
                if (familyKey === "worldInfo") continue;
                if (familyKey === "homelessSims") {
                    if (simData[familyKey] && simData[familyKey].find(s => s.name === simName)) {
                        currentSelectedFamily = "homelessSims"; // Special key for homeless
                        break;
                    }
                } else if (simData[familyKey].members && simData[familyKey].members.find(s => s.name === simName)) {
                    currentSelectedFamily = familyKey;
                    break;
                }
            }

            updateFamilyList(); // Re-render the family list to apply selected states
            hideAllContentSections();
            displaySimDetails(currentSelectedSim);
        }
    </script>
</body>
</html>
