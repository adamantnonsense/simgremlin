import React, { useState, useEffect, useMemo, useRef } from 'react';

// Helper function to get mock Sim Biographies data
const getMockSimsData = () => [
  // Bella Goth
  {
    id: 'sim-1',
    firstName: 'Bella',
    name: 'Goth',
    household: 'Goth family',
    imageBaby: 'https://placehold.co/80x80/EC4899/ffffff?text=B',
    imageToddler: 'https://placehold.co/80x80/DB2777/ffffff?text=T',
    imageChild: 'https://placehold.co/80x80/C026D3/ffffff?text=C',
    imageTeen: 'https://placehold.co/80x80/9333EA/ffffff?text=Tn',
    imageYoungAdult: 'https://placehold.co/200x250/F87171/ffffff?text=Bella+Goth',
    imageAdult: 'https://placehold.co/80x80/6D28D9/ffffff?text=A',
    imageElder: 'https://placehold.co/80x80/4C1D95/ffffff?text=E',
    title: 'Matriarch',
    bio: 'Bella Goth is the iconic matriarch of the Goth family, known for her mysterious charm and enigmatic presence. She loves her family dearly and often finds herself caught in dramatic neighborhood events, always with a flair for the dramatic. Rumored to have been abducted by aliens multiple times, she maintains a composed demeanor.',
    notes: 'Keeps a hidden journal. Has a secret fondness for gardening despite her elegant appearance. Very protective of Cassandra.',
    status: 'Alive',
    occultStatus: 'None',
    gender: 'Female',
    age: 'Adult',
    zodiac: 'Scorpio',
    aspiration: 'Family',
    lifetimeWish: 'Reach Max Level in Logic Skill',
    aspirationSims4: 'Successful Lineage',
    career: 'Journalist',
    careerLvl: 9,
    maritalStatus: 'Married',
    partners: ['Mortimer Goth'],
    siblings: [],
    parent1: null,
    parent2: null,
    children: ['Cassandra Goth', 'Alexander Goth'],
    skill1: 'Logic',
    skill1Lvl: 10,
    skill2: 'Charisma',
    skill2Lvl: 8,
    skill3: 'Writing',
    skill3Lvl: 7,
    traits: ['Family-Oriented', 'Good Sense of Humor', 'Loves Outdoors', 'Neat', 'Genius'],
    bonusTrait: 'Observant',
    personalitySloppyNeat: 'Neat',
    personalityShyOutgoing: 'Outgoing',
    personalityLazyActive: 'Active',
    personalitySeriousPlayful: 'Playful',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Lobster Thermidor',
    favoriteMusic: 'Classical',
    favoriteColor: 'Red',
    interest1: 'Paranormal',
    interest1Lvl: 8,
    dislikedInterest1: 'Sports',
    dislikedInterest1Lvl: 2,
    hobby: 'Astronomy',
    skinColor: 'Light',
    hairColor: 'Black',
    fitness: 'Fit',
    eyeColor: 'Brown',
    turnOn1: 'Fitness',
    turnOn2: 'Charismatic Sims',
    turnOff: 'Bad Hygiene',
    fullName: 'Bella Goth'
  },
  // Mortimer Goth
  {
    id: 'sim-2',
    firstName: 'Mortimer',
    name: 'Goth',
    household: 'Goth family',
    imageBaby: 'https://placehold.co/80x80/3B82F6/ffffff?text=B',
    imageToddler: 'https://placehold.co/80x80/2563EB/ffffff?text=T',
    imageChild: 'https://placehold.co/80x80/1D4ED8/ffffff?text=C',
    imageTeen: 'https://placehold.co/80x80/1E3A8A/ffffff?text=Tn',
    imageYoungAdult: 'https://placehold.co/200x250/60A5FA/ffffff?text=Mortimer+Goth',
    imageAdult: 'https://placehold.co/80x80/172554/ffffff?text=A',
    imageElder: 'https://placehold.co/80x80/0F172A/ffffff?text=E',
    title: 'Patriarch',
    bio: 'Mortimer Goth is a distinguished scientist with a passion for logic and the macabre. He is devoted to his family and enjoys quiet evenings at home, often pondering the mysteries of the universe and conducting unusual experiments in his private laboratory. He has a keen interest in all things supernatural.',
    notes: 'Frequently stays up late researching forgotten tomes. Believes in extraterrestrial life and seeks proof. Secretly afraid of clowns.',
    status: 'Alive',
    occultStatus: 'None',
    gender: 'Male',
    age: 'Adult',
    zodiac: 'Virgo',
    aspiration: 'Knowledge',
    lifetimeWish: 'Become Mad Scientist',
    aspirationSims4: 'Nerd Brain',
    career: 'Scientist',
    careerLvl: 10,
    maritalStatus: 'Married',
    partners: ['Bella Goth'],
    siblings: [],
    parent1: null,
    parent2: null,
    children: ['Cassandra Goth', 'Alexander Goth'],
    skill1: 'Logic',
    skill1Lvl: 10,
    skill2: 'Handiness',
    skill2Lvl: 7,
    skill3: 'Gardening',
    skill3Lvl: 5,
    traits: ['Genius', 'Loves Books', 'Geek', 'Serious', 'Loner'],
    bonusTrait: 'Analytical',
    personalitySloppyNeat: 'Neat',
    personalityShyOutgoing: 'Shy',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Serious',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Mac and Cheese',
    favoriteMusic: 'Classical',
    favoriteColor: 'Purple',
    interest1: 'Science',
    interest1Lvl: 10,
    dislikedInterest1: 'Parties',
    dislikedInterest1Lvl: 1,
    hobby: 'Tinkering',
    skinColor: 'Fair',
    hairColor: 'Black',
    fitness: 'Average',
    eyeColor: 'Green',
    turnOn1: 'Formal Wear',
    turnOn2: 'Intelligence',
    turnOff: 'Too Playful',
    fullName: 'Mortimer Goth'
  },
  // Cassandra Goth
  {
    id: 'sim-3',
    firstName: 'Cassandra',
    name: 'Goth',
    household: 'Goth family',
    imageBaby: 'https://placehold.co/80x80/7C3AED/ffffff?text=B',
    imageToddler: 'https://placehold.co/80x80/6D28D9/ffffff?text=T',
    imageChild: 'https://placehold.co/80x80/5B21B6/ffffff?text=C',
    imageTeen: 'https://placehold.co/80x80/4C1D95/ffffff?text=Tn',
    imageYoungAdult: 'https://placehold.co/200x250/8B5CF6/ffffff?text=Cassandra+Goth',
    imageAdult: 'https://placehold.co/80x80/3B0764/ffffff?text=A',
    imageElder: 'https://placehold.co/80x80/2F004F/ffffff?text=E',
    title: 'Heiress',
    bio: 'Cassandra Goth is the artistic and somewhat moody daughter of Bella and Mortimer. She dreams of a career in music and often feels misunderstood by her eccentric family. Despite her quiet nature, she possesses a passionate creative spirit that she expresses through her melodies and art.',
    notes: 'Spends hours playing the piano and violin. Has a secret crush on the Landgraab heir. Wishes her parents would be "normal" for once.',
    status: 'Alive',
    occultStatus: 'None',
    gender: 'Female',
    age: 'Young Adult',
    zodiac: 'Pisces',
    aspiration: 'Popularity',
    lifetimeWish: 'Become a Rock Star',
    aspirationSims4: 'Soulmate',
    career: 'Musician',
    careerLvl: 6,
    maritalStatus: 'Single',
    partners: [],
    siblings: ['Alexander Goth'],
    parent1: 'Bella Goth',
    parent2: 'Mortimer Goth',
    children: [],
    skill1: 'Creativity',
    skill1Lvl: 9,
    skill2: 'Guitar',
    skill2Lvl: 7,
    skill3: 'Piano',
    skill3Lvl: 8,
    traits: ['Brooding', 'Artistic', 'Music Lover', 'Unflirty', 'Loyal'],
    bonusTrait: 'Muser',
    personalitySloppyNeat: 'Sloppy',
    personalityShyOutgoing: 'Shy',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Serious',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Grilled Cheese',
    favoriteMusic: 'Pop',
    favoriteColor: 'Black',
    interest1: 'Music',
    interest1Lvl: 9,
    dislikedInterest1: 'Logic',
    dislikedInterest1Lvl: 2,
    hobby: 'Playing Instruments',
    skinColor: 'Light',
    hairColor: 'Black',
    fitness: 'Thin',
    eyeColor: 'Brown',
    turnOn1: 'Bad Boys',
    turnOn2: 'Artistic Sims',
    turnOff: 'Athletic Sims',
    fullName: 'Cassandra Goth'
  },
  // Alexander Goth
  {
    id: 'sim-4',
    firstName: 'Alexander',
    name: 'Goth',
    household: 'Goth family',
    imageBaby: 'https://placehold.co/80x80/16A34A/ffffff?text=B',
    imageToddler: 'https://placehold.co/80x80/15803D/ffffff?text=T',
    imageChild: 'https://placehold.co/80x80/14532D/ffffff?text=C',
    imageTeen: 'https://placehold.co/80x80/052E16/ffffff?text=Tn',
    imageYoungAdult: 'https://placehold.co/200x250/22C55E/ffffff?text=Alexander+Goth',
    imageAdult: 'https://placehold.co/80x80/042F2E/ffffff?text=A',
    imageElder: 'https://placehold.co/80x80/011C1C/ffffff?text=E',
    title: 'Prodigy',
    bio: 'Alexander Goth is the intelligent and introverted youngest child of the Goth family. He shows a keen interest in science and enjoys spending time alone with his books and telescope. He often dreams of exploring the furthest reaches of space.',
    notes: 'Currently obsessed with space travel and alien theories. Wants a pet alien. Finds social gatherings overwhelming.',
    status: 'Alive',
    occultStatus: 'None',
    gender: 'Male',
    age: 'Teen',
    zodiac: 'Aries',
    aspiration: 'Knowledge',
    lifetimeWish: 'Become a Visionary',
    aspirationSims4: 'Whiz Kid',
    career: 'High School Student',
    careerLvl: null,
    maritalStatus: 'Single',
    partners: [],
    siblings: ['Cassandra Goth'],
    parent1: 'Bella Goth',
    parent2: 'Mortimer Goth',
    children: [],
    skill1: 'Logic',
    skill1Lvl: 8,
    skill2: 'Rocket Science',
    skill2Lvl: 4,
    skill3: 'Video Gaming',
    skill3Lvl: 6,
    traits: ['Bookworm', 'Loves Outdoors', 'Clumsy', 'Genius', 'Absent-Minded'],
    bonusTrait: 'Inquisitive',
    personalitySloppyNeat: 'Neat',
    personalityShyOutgoing: 'Shy',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Serious',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Fish and Chips',
    favoriteMusic: 'Kids',
    favoriteColor: 'Blue',
    interest1: 'Science',
    interest1Lvl: 9,
    dislikedInterest1: 'Sports',
    dislikedInterest1Lvl: 1,
    hobby: 'Reading',
    skinColor: 'Fair',
    hairColor: 'Brown',
    fitness: 'Average',
    eyeColor: 'Green',
    turnOn1: null,
    turnOn2: null,
    turnOff: null,
    fullName: 'Alexander Goth'
  },
  // Vladislaus Straud (Vampire)
  {
    id: 'sim-5',
    firstName: 'Vladislaus',
    name: 'Straud',
    household: 'Straud family',
    imageYoungAdult: 'https://placehold.co/200x250/374151/ffffff?text=Vladislaus+Straud',
    imageAdult: 'https://placehold.co/80x80/1F2937/ffffff?text=A',
    imageElder: 'https://placehold.co/80x80/111827/ffffff?text=E',
    title: 'Ancient Vampire',
    bio: 'Vladislaus Straud IV is the ancient and mysterious founder of Forgotten Hollow. He is a powerful vampire who enjoys the quiet solitude of his mansion and occasionally dabbles in minor neighborhood mischief. He finds modern life perplexing.',
    notes: 'Dislikes sunlight intensely. Has a collection of ancient artifacts. Still trying to understand "selfies." Rarely leaves his manor during the day.',
    status: 'Alive',
    occultStatus: 'Vampire',
    gender: 'Male',
    age: 'Elder', // Or ancient adult
    zodiac: 'Capricorn',
    aspiration: 'Knowledge',
    lifetimeWish: 'Master Vampire Lore',
    aspirationSims4: 'Vampire Family',
    career: 'Unemployed', // Or retired
    careerLvl: null,
    maritalStatus: 'Single',
    partners: [],
    siblings: [],
    parent1: null,
    parent2: null,
    children: [],
    skill1: 'Vampire Lore',
    skill1Lvl: 15, // Max for Vampires
    skill2: 'Pipe Organ',
    skill2Lvl: 10,
    skill3: 'Charisma',
    skill3Lvl: 6,
    traits: ['Loner', 'Evil', 'Mean', 'Gloomy', 'Night Owl'],
    bonusTrait: 'Master of Darkness',
    personalitySloppyNeat: 'Neat',
    personalityShyOutgoing: 'Shy',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Serious',
    personalityGrouchyNice: 'Grouchy',
    favoriteFood: 'Plasma Pack',
    favoriteMusic: 'Classical',
    favoriteColor: 'Black',
    interest1: 'Vampire Lore',
    interest1Lvl: 10,
    dislikedInterest1: 'Fitness',
    dislikedInterest1Lvl: 1,
    hobby: 'Playing Pipe Organ',
    skinColor: 'Pale',
    hairColor: 'Black',
    fitness: 'Unfit',
    eyeColor: 'Red',
    turnOn1: 'Gothic Attire',
    turnOn2: 'Fear',
    turnOff: 'Garlic',
    fullName: 'Vladislaus Straud'
  },
  // Lily Zest (Comedian)
  {
    id: 'sim-6',
    firstName: 'Lily',
    name: 'Zest',
    household: 'Zest household',
    imageYoungAdult: 'https://placehold.co/200x250/EC4899/ffffff?text=Lily+Zest',
    imageAdult: 'https://placehold.co/80x80/DB2777/ffffff?text=A',
    title: 'Aspiring Comedian',
    bio: 'Lily Zest is a cheerful and ambitious Sim who dreams of becoming a famous comedian. She lives in Oasis Springs and is always ready with a witty remark or a silly joke. She tries to find humor in every situation, even when things go wrong.',
    notes: 'Practices stand-up routines in front of the mirror. Tries to make everyone laugh. Struggles with confidence sometimes.',
    status: 'Alive',
    occultStatus: 'None',
    gender: 'Female',
    age: 'Young Adult',
    zodiac: 'Leo',
    aspiration: 'Popularity',
    lifetimeWish: 'Achieve Global Superstar',
    aspirationSims4: 'Joke Star',
    career: 'Comedian',
    careerLvl: 4,
    maritalStatus: 'Single',
    partners: [],
    siblings: [],
    parent1: null,
    parent2: null,
    children: [],
    skill1: 'Comedy',
    skill1Lvl: 7,
    skill2: 'Charisma',
    skill2Lvl: 5,
    skill3: 'Mischief',
    skill3Lvl: 3,
    traits: ['Outgoing', 'Goofball', 'Ambitious', 'Creative', 'Self-Assured'],
    bonusTrait: 'Gregarious',
    personalitySloppyNeat: 'Sloppy',
    personalityShyOutgoing: 'Outgoing',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Playful',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Grilled Cheese',
    favoriteMusic: 'Pop',
    favoriteColor: 'Yellow',
    interest1: 'Comedy',
    interest1Lvl: 9,
    dislikedInterest1: 'Gardening',
    dislikedInterest1Lvl: 1,
    hobby: 'Performing',
    skinColor: 'Medium',
    hairColor: 'Red',
    fitness: 'Average',
    eyeColor: 'Green',
    turnOn1: 'Good Sense of Humor',
    turnOn2: 'Outgoing Sims',
    turnOff: 'Mean Sims',
    fullName: 'Lily Zest'
  },
  // Johnny Zest (Disowned Landgraab)
  {
    id: 'sim-7',
    firstName: 'Johnny',
    name: 'Zest', // Not directly related to Lily Zest, but shares surname
    household: 'Zest household',
    imageYoungAdult: 'https://placehold.co/200x250/6EE7B7/ffffff?text=Johnny+Zest',
    title: 'Unemployed Aspiring Performer',
    bio: 'Johnny Zest is a struggling comedian who was disowned by the Landgraabs. Despite his misfortunes, he remains optimistic and determined to make it big in the entertainment industry. He lives in a trailer and works hard on his craft.',
    notes: 'Ex-Landgraab. Practices jokes constantly. Dreams of winning a comedy award. Often broke.',
    status: 'Alive',
    occultStatus: 'None',
    gender: 'Male',
    age: 'Young Adult',
    zodiac: 'Gemini',
    aspiration: 'Popularity',
    lifetimeWish: 'Become a World Renowned Celebrity',
    aspirationSims4: 'Joke Star',
    career: 'Unemployed', // Or part-time job
    careerLvl: null,
    maritalStatus: 'Single',
    partners: [],
    siblings: [], // Can link to Landgraabs later if desired
    parent1: 'Nancy Landgraab (Disowned)',
    parent2: 'Geoffrey Landgraab (Disowned)',
    children: [],
    skill1: 'Comedy',
    skill1Lvl: 6,
    skill2: 'Charisma',
    skill2Lvl: 4,
    skill3: 'Guitar',
    skill3Lvl: 2,
    traits: ['Outgoing', 'Goofball', 'Creative', 'Noncommittal'],
    bonusTrait: 'Gregarious',
    personalitySloppyNeat: 'Sloppy',
    personalityShyOutgoing: 'Outgoing',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Playful',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Pizza',
    favoriteMusic: 'Electronica',
    favoriteColor: 'Orange',
    interest1: 'Comedy',
    interest1Lvl: 8,
    dislikedInterest1: 'Cleaning',
    dislikedInterest1Lvl: 1,
    hobby: 'Performing',
    skinColor: 'Light',
    hairColor: 'Blonde',
    fitness: 'Average',
    eyeColor: 'Blue',
    turnOn1: 'Good Sense of Humor',
    turnOn2: 'Playful Sims',
    turnOff: 'Serious Sims',
    fullName: 'Johnny Zest'
  },
  {
    id: 'sim-8',
    firstName: 'Caleb',
    name: 'Vatore',
    household: 'Vatore household',
    imageYoungAdult: 'https://placehold.co/200x250/2563EB/ffffff?text=Caleb+Vatore',
    imageAdult: 'https://placehold.co/80x80/1D4ED8/ffffff?text=A',
    title: 'Good Vampire',
    bio: 'Caleb Vatore is a kind-hearted vampire who strives to be a good Sim and avoid the typical vampiric stereotypes. He prefers plasma packs over biting Sims and loves socializing, often trying to make new friends in Forgotten Hollow.',
    notes: 'Secretly practices magic. Tries to convert Vladislaus to be good. Has a sister, Lilith Vatore.',
    status: 'Alive',
    occultStatus: 'Vampire',
    gender: 'Male',
    age: 'Young Adult',
    zodiac: 'Cancer',
    aspiration: 'Popularity',
    lifetimeWish: 'Good Vampire',
    aspirationSims4: 'Good Vampire',
    career: 'Mixologist',
    careerLvl: 5,
    maritalStatus: 'Single',
    partners: [],
    siblings: ['Lilith Vatore'],
    parent1: null,
    parent2: null,
    children: [],
    skill1: 'Vampire Lore',
    skill1Lvl: 8,
    skill2: 'Charisma',
    skill2Lvl: 7,
    skill3: 'Mixology',
    skill3Lvl: 6,
    traits: ['Good', 'Brooding', 'Loves Outdoors', 'Perfectionist'],
    bonusTrait: 'Kindly Vampire',
    personalitySloppyNeat: 'Neat',
    personalityShyOutgoing: 'Outgoing',
    personalityLazyActive: 'Lazy',
    personalitySeriousPlayful: 'Playful',
    personalityGrouchyNice: 'Nice',
    favoriteFood: 'Plasma Fruit Salad',
    favoriteMusic: 'Blues',
    favoriteColor: 'Blue',
    interest1: 'Vampire Lore',
    interest1Lvl: 7,
    dislikedInterest1: 'Fighting',
    dislikedInterest1Lvl: 1,
    hobby: 'Reading',
    skinColor: 'Pale',
    hairColor: 'Dark Brown',
    fitness: 'Fit',
    eyeColor: 'Brown',
    turnOn1: 'Nice Sims',
    turnOn2: 'Intelligent Sims',
    turnOff: 'Mean Sims',
    fullName: 'Caleb Vatore'
  },
];

// Mock data for news articles if CSV fetch fails or is empty
const getMockNewsData = () => {
  const filteredArticles = [
    {
      id: '0001',
      headline: 'Rubber Duck Mystery Deepens in Willow Creek',
      date: 'June 20, 2025',
      content: 'Residents of Willow Creek are baffled by the sudden vanishing act of dozens of rubber ducks from local fountains and bathtubs. The police are investigating whether it\'s a prank, an odd art installation, or something more sinister. This incident has sparked a town-wide debate and a new fascination with bath toys.',
      image: 'https://64.media.tumblr.com/cc945a084bfd292dea717d0abc574a7b/f21acf2c10ef62f4-1b/s1280x1920/885ea0f18be74b1a16ad7e436c61b71f74a2cfb1.pnj',
    },
    {
      id: '0022',
      headline: 'Olivia Pine Wins Newcrest Pie Contest with Secret Ingredient',
      date: 'June 19, 2025',
      content: 'Olivia Pine, a renowned local baker, won the annual Newcrest Pie Contest. Her secret ingredient, as she stated, "A pinch of magic and a whole lot of Sim-love!". This unexpected turn of events has everyone talking about her newfound culinary genius, leading to a surge in pie sales across the neighborhood.',
      image: 'https://adamantnonsense.github.io/simgremlin/005.jpg',
    },
    {
      id: '9000',
      headline: 'Frank Cedars\' Garden Bursts into Operatic Song',
      date: 'June 18, 2025',
      content: 'Frank Cedars\' meticulously tended garden has literally taken on a life of its own, with his prize-winning roses and sunflowers spontaneously bursting into operatic arias, much to the delight and confusion of passersby. Scientists are baffled by this botanical phenomenon, and tourists are flocking to witness the singing garden.',
      image: 'https://adamantnonsense.github.io/simgremlin/005.jpg',
    },
  ];

  // Headlines to filter out (explicitly marked as "fake" by user)
  const headlinesToFilter = [
    'Dustin Broke Becomes Internet Sensation Overnight', // Covers "Dustin broke viral"
    'New Occult Restaurant "Plasma Feast" Opens in Forgotten Hollow', // Covers "plasma fruit"
    'Wellness Guru Introduces Llama Yoga to Willow Creek',
    'Local Architect Builds Upside-Down House, Confounds Town Planners',
  ];

  return filteredArticles.filter(article => !headlinesToFilter.includes(article.headline));
};


// --- SearchBar Component ---
const SearchBar = ({ onSearch, onToggleFullScreen, isFullScreen, searchResults, onResultClick }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [searchType, setSearchType] = useState('sim'); // 'sim' or 'family'
  const [showDropdown, setShowDropdown] = useState(false);
  const dropdownRef = useRef(null);
  const inputRef = useRef(null);

  useEffect(() => {
    // Close dropdown if clicked outside
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target) &&
          inputRef.current && !inputRef.current.contains(event.target)) {
        setShowDropdown(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  const handleSearchChange = (e) => {
    const term = e.target.value;
    setSearchTerm(term);
    setShowDropdown(term.length > 0); // Show dropdown only if there's a search term
    onSearch(term, searchType);
  };

  const handleTypeChange = (e) => {
    const type = e.target.value;
    setSearchType(type);
    onSearch(searchTerm, type); // Re-run search with new type
    setShowDropdown(searchTerm.length > 0); // Keep dropdown visible if term exists
  };

  const handleClearSearch = () => {
    setSearchTerm('');
    setShowDropdown(false);
    onSearch('', searchType); // Clear search results
  };

  const handleFullScreenToggle = () => {
    onToggleFullScreen(!isFullScreen);
    if (!isFullScreen) { // If going into full screen, clear search for fresh start
      setSearchTerm('');
      onSearch('', searchType);
      setShowDropdown(false); // Hide dropdown initially in full screen
    }
  };

  const handleInputFocus = () => {
    if (isFullScreen && searchTerm.length > 0) {
      setShowDropdown(true); // Show dropdown on focus if in full screen and has term
    } else if (!isFullScreen) {
      // For compact search bar, directly toggle full screen on focus
      handleFullScreenToggle();
    }
  };

  const handleDropdownItemClick = (item, type, allItems, index, e) => {
    e.stopPropagation(); // Prevent modal from closing immediately after opening
    onResultClick(item, type, allItems, index);
    setSearchTerm(''); // Clear search term after selection
    setShowDropdown(false); // Hide dropdown
    onToggleFullScreen(false); // Exit full screen search
  };


  return (
    <>
      <div className={`relative flex items-center bg-gray-200 rounded-full py-2 px-4 shadow-inner cursor-pointer transition-all duration-300 ${isFullScreen ? 'hidden' : 'w-full max-w-sm'}`}
           onClick={handleFullScreenToggle} // Clicking compact bar toggles full screen
           ref={inputRef} // Assign ref to the compact input container
      >
        <input
          type="text"
          placeholder={`Search ${searchType}...`}
          className="bg-transparent outline-none flex-grow text-gray-800 placeholder-gray-500 cursor-pointer"
          readOnly // Make it read-only to force click for full screen
          value={searchTerm} // Display current search term even when readOnly
        />
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      {isFullScreen && (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-95 flex flex-col justify-center items-center z-50 p-4">
          <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 relative">
            <button
              onClick={handleFullScreenToggle}
              className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-4xl font-light leading-none"
              aria-label="Close search"
            >
              &times;
            </button>
            <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Search Neighborhood</h2>

            <div className="mb-6 relative">
              <label htmlFor="search-input" className="sr-only">Search term</label>
              <input
                id="search-input"
                type="text"
                placeholder={`Search for a ${searchType} name...`}
                className="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm"
                value={searchTerm}
                onChange={handleSearchChange}
                onFocus={handleInputFocus}
                autoFocus
              />
              {showDropdown && searchResults && searchResults.length > 0 && (
                <ul ref={dropdownRef} className="absolute left-0 right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-10">
                  {searchResults.map((result, index) => (
                    <li
                      key={result.id || index}
                      className="px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0"
                      onClick={(e) => handleDropdownItemClick(result, searchType, searchResults, index, e)}
                    >
                      {searchType === 'sim' ? result.fullName : result.name}
                      {searchType === 'sim' && result.household && <span className="text-gray-500 text-sm ml-2">({result.household})</span>}
                    </li>
                  ))}
                </ul>
              )}
            </div>

            <div className="flex justify-center items-center space-x-6 mb-8">
              <label className="flex items-center text-lg cursor-pointer">
                <input
                  type="radio"
                  name="searchType"
                  value="sim"
                  checked={searchType === 'sim'}
                  onChange={handleTypeChange}
                  className="form-radio h-5 w-5 text-blue-600 transition-colors"
                />
                <span className="ml-2 text-gray-700">Search Sims</span>
              </label>
              <label className="flex items-center text-lg cursor-pointer">
                <input
                  type="radio"
                  name="searchType"
                  value="family"
                  checked={searchType === 'family'}
                  onChange={handleTypeChange}
                  className="form-radio h-5 w-5 text-blue-600 transition-colors"
                />
                <span className="ml-2 text-gray-700">Search Families</span>
              </label>
            </div>

            <div className="flex justify-center">
              <button
                onClick={handleClearSearch}
                className="bg-red-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-red-600 transition-colors text-lg"
              >
                Clear Search
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};


// Main App Component
const App = () => {
  const [currentPage, setCurrentPage] = useState('simBiographies'); // Default page
  const [db, setDb] = useState(null); // Firestore instance
  const [auth, setAuth] = useState(null); // Firebase Auth instance
  const [simsData, setSimsData] = useState([]); // State to hold Sim Biographies data
  const [newsData, setNewsData] = useState([]); // State to hold Neighborhood News data
  const [expandedItem, setExpandedItem] = useState(null); // State for the currently expanded item (Sim, Family, News)

  // Search States
  const [searchTerm, setSearchTerm] = useState('');
  const [searchType, setSearchType] = useState('sim');
  const [isSearchFullScreen, setIsSearchFullScreen] = useState(false);

  // Firebase Initialization and Authentication (Placeholder for actual Firebase integration)
  useEffect(() => {
    // Placeholder for userId (remove when Firebase is fully integrated)
    setDb({}); // Mock db object
    setAuth({}); // Mock auth object
  }, []);

  // CSV Parsing Function for Sims
  const parseSimsCsv = (csvText) => {
    const lines = csvText.split('\n').filter(line => line.trim() !== '');
    if (lines.length === 0) return [];

    const headers = lines[0].split(',').map(header => header.trim());
    const data = lines.slice(1).map(line => {
      const values = line.split(',').map(value => value.trim());
      const row = {};
      headers.forEach((header, index) => {
        let cleanHeader = header
          .replace(/[\s\.]/g, '')
          .replace(/\(Sims4\)/g, 'Sims4');

        if (cleanHeader.startsWith('Image_')) {
          const parts = cleanHeader.split('_');
          if (parts.length > 1 && parts[1]) {
            const camelCasedPart = parts[1].charAt(0).toUpperCase() + parts[1].slice(1);
            cleanHeader = `image${camelCasedPart}`;
          } else {
            cleanHeader = 'image';
          }
        } else {
          cleanHeader = cleanHeader.charAt(0).toLowerCase() + cleanHeader.slice(1);
        }
        row[cleanHeader] = values[index];
      });

      row.traits = [
        row.traits, row.trait2, row.trait3, row.trait4, row.trait5, row.bonusTrait
      ].flat().filter(Boolean);

      row.partners = row.partners ? row.partners.split(';').map(p => p.trim()).filter(Boolean) : [];
      row.siblings = row.siblings ? row.siblings.split(';').map(s => s.trim()).filter(Boolean) : [];
      row.children = row.children ? row.children.split(';').map(c => c.trim()).filter(Boolean) : [];

      row.id = row.id || `${row.firstName}-${row.name}-${Math.random().toString(36).substr(2, 9)}`;
      // Combine firstName and name for easier display in census
      row.fullName = `${row.firstName || ''} ${row.name || ''}`.trim();

      return row;
    });
    return data;
  };

  // CSV Parsing Function for News
  const parseNewsCsv = (csvText) => {
    const lines = csvText.split('\n').filter(line => line.trim() !== '');
    if (lines.length === 0) return [];

    const headers = lines[0].split(',').map(header => header.trim().toLowerCase());
    const data = lines.slice(1).map(line => {
      const values = line.split(',').map(value => value.trim());
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index];
      });
      // Ensure 'id' and 'image' fields are present, and 'date' is formatted
      row.id = row.id || `news-${Math.random().toString(36).substr(2, 9)}`;
      row.image = row.image || 'https://placehold.co/600x300/A0AEC0/ffffff?text=News';
      row.date = row.date || new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      return row;
    });

    // Filter out specific "fake" headlines after parsing
    const headlinesToFilter = [
      'Dustin Broke Becomes Internet Sensation Overnight', // Covers "Dustin broke viral"
      'New Occult Restaurant "Plasma Feast" Opens in Forgotten Hollow', // Covers "plasma fruit"
      'Wellness Guru Introduces Llama Yoga to Willow Creek',
      'Local Architect Builds Upside-Down House, Confounds Town Planners',
      'Rubber Duck Mystery Deepens in Willow Creek',
      'Elder Sim Discovers Hidden Talent for DJing',
      'Alien Visitor Attempts to Understand "Human Humor"',
      'Frank Cedars\' Garden Bursts into Operatic Song',
      'Olivia Pine Wins Newcrest Pie Contest with Secret Ingredient',
    ];

    return data.filter(article => !headlinesToFilter.includes(article.headline));
  };


  // Fetch Sim Biographies data
  useEffect(() => {
    const fetchSimBiographies = async () => {
      const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSs1l3tUbLZpKfZCUxSkdYYsRcneV_PsoF7yPLJ3YdZr_tsVSOo3qcH4idIjwmx-f4U7rMb7_nBDSuV/pub?gid=522782907&single=true&output=csv';
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const parsedData = parseSimsCsv(csvText); // Use parseSimsCsv
        setSimsData(parsedData);
      } catch (error) {
        console.error("Error fetching Sim Biographies data:", error);
        // Fallback to mock data if fetching fails
        setSimsData(getMockSimsData());
      }
    };

    fetchSimBiographies();
  }, []);

  // Fetch Neighborhood News data (new useEffect)
  useEffect(() => {
    const fetchNeighborhoodNews = async () => {
      // Mock CSV URL for News (replace with real if available)
      const newsUrl = 'https://mock-data-url.com/neighborhood-news.csv'; // Placeholder URL
      try {
        const response = await fetch(newsUrl);
        if (!response.ok) {
          // If mock URL fails, fall back to hardcoded mock data
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const parsedData = parseNewsCsv(csvText); // Use parseNewsCsv
        setNewsData(parsedData);
      } catch (error) {
        console.warn("Could not fetch news data from CSV. Falling back to mock news data.", error);
        setNewsData(getMockNewsData()); // Fallback to getMockNewsData
      }
    };

    fetchNeighborhoodNews();
  }, []);


  const handleNavigationClick = (page) => {
    setCurrentPage(page);
    setExpandedItem(null); // Close any expanded view when changing pages
  };

  // New function to handle opening expanded view with all items and current index
  const handleOpenExpandedView = (item, type, allItems = [], currentIndex = -1) => {
    setExpandedItem({ item, type, allItems, currentIndex });
  };

  const handleCloseExpandedView = () => {
    setExpandedItem(null);
  };

  const handleSearch = (term, type) => {
    setSearchTerm(term);
    setSearchType(type);
  };

  // Filtered data based on search term and type
  const filteredSimsData = useMemo(() => {
    if (!searchTerm) return simsData;
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    return simsData.filter(sim =>
      sim.fullName.toLowerCase().includes(lowerCaseSearchTerm) ||
      (sim.household && sim.household.toLowerCase().includes(lowerCaseSearchTerm))
    );
  }, [simsData, searchTerm]);

  // Family data (currently mock, but now filtered)
  const allFamiliesData = useMemo(() => {
    const rawFamilyData = [
      { householdName: 'Behr', funds: 10000, biography: 'The Behr household, home to the dynamic duo of Candy and Yuki. They are known for their love of music and their vibrant personalities, always ready to throw a dance party. Their modern home is filled with eccentric art and a professional DJ booth.', imgFamilyBio: 'https://placehold.co/400x200/C026D3/ffffff?text=Behr+Family' },
      { householdName: 'BFF household', funds: 5000, biography: 'A group of inseparable friends living together: Summer Holiday, Travis Scott, and Liberty Lee. They are young, ambitious, and navigating the ups and downs of adulting, always supporting each other through career struggles and romantic misadventures. Their house is a hub of laughter and video games.', imgFamilyBio: 'https://placehold.co/400x200/9333EA/ffffff?text=BFF+Household' },
      { householdName: 'Bjergsen', funds: 75000, biography: 'Bjorn and Clara Bjergsen, a seemingly perfect family with hidden depths. Their daughter Sofia is a talented musician. Despite their public image, Bjorn often feels distant, and Clara struggles to keep the family\'s facade intact. Their elegant home in Windenburg is a testament to their wealth and status.', imgFamilyBio: 'https://placehold.co/400x200/6D28D9/ffffff?text=Bjergsen+Family' },
      { householdName: 'Bro', funds: 20000, biography: 'Three brothers who love gaming and living life to the fullest: Geoffrey, Travis, and John. Their bachelor pad is perpetually messy, filled with pizza boxes and gaming consoles. They are fiercely loyal to each other, even if their competitive streak sometimes gets the better of them.', imgFamilyBio: 'https://placehold.co/400x200/4C1D95/ffffff?text=Bro+Household' },
      { householdName: 'Bun Ma family', funds: 15000, biography: 'A cozy family with a love for traditional cooking. They recently moved to San Myshuno and are enjoying the vibrant city life, bringing their grandmother\'s recipes to the local food festivals. Their apartment is always filled with the aroma of delicious spices.', imgFamilyBio: 'https://placehold.co/400x200/3B0764/ffffff?text=Bun+Ma+Family' },
      { householdName: 'Cahil family', funds: 12000, biography: 'A family with a passion for the outdoors and adventure. They spend most weekends hiking, fishing, and camping in Granite Falls. Their home is filled with souvenirs from their travels and maps of unexplored territories.', imgFamilyBio: 'https://placehold.co/400x200/EC4899/ffffff?text=Cahil+Family' },
      { householdName: 'Cahyaputri family', funds: 18000, biography: 'Known for their hospitality and artistic endeavors. They frequently host painting workshops and open mic nights in their backyard, bringing the community together with their creative spirit. Their vibrant garden is as colorful as their personalities.', imgFamilyBio: 'https://placehold.co/400x200/DB2777/ffffff?text=Cahyaputri+Family' },
      { householdName: 'Eclectic Arts household', funds: 30000, biography: 'A vibrant household of creative Sims, always inspiring each other. This collective of painters, sculptors, and musicians thrives on collaboration and artistic expression. Their shared studio space is a chaotic but inspiring mess of ongoing projects.', imgFamilyBio: 'https://placehold.co/400x200/C026D3/ffffff?text=Eclectic+Arts' },
      { householdName: 'Family Name', funds: 0, biography: 'This is a placeholder for a new family, ready for your stories to unfold.', imgFamilyBio: '' },
      { householdName: 'Free Spirils', funds: 10000, biography: 'Embracing independence and unconventional lifestyles, this household lives life on their own terms. They are often found traveling, exploring new cultures, and expressing themselves through street art and performance. Their home is a temporary stop before their next adventure.', imgFamilyBio: 'https://placehold.co/400x200/9333EA/ffffff?text=Free+Spirits' },
      { householdName: 'Fyres', funds: 45000, biography: 'A large, lively family with a knack for mischief and fun. Siobhan and Morgan Fyres lead a household of energetic Sims who love pranks and outdoor activities. Their annual camping trips are legendary for their wild stories and unexpected twists.', imgFamilyBio: 'https://placehold.co/400x200/6D28D9/ffffff?text=Fyres+Family' },
      { householdName: 'Goth family', funds: 999999, biography: 'The mysterious and wealthy Goth family, steeped in history and gothic charm. Mortimer, Bella, Cassandra, and Alexander reside in their grand mansion, where secrets and shadows linger around every corner. They are known for their intelligence, elegance, and occasional encounters with the supernatural.', imgFamilyBio: 'https://placehold.co/400x200/F87171/ffffff?text=Goth+Family' },
      { householdName: 'Hoapil', funds: 25000, biography: 'A warm and welcoming island family. The Hoapil family are deeply connected to the culture and traditions of Sulani. They are environmentally conscious, love the ocean, and enjoy teaching others about island living. Their beachfront home is always open to friends and family.', imgFamilyBio: 'https://placehold.co/400x200/22C55E/ffffff?text=Hoapil+Family' },
      { householdName: 'Jaleel household', funds: 8000, biography: 'A small family focused on community and learning. They are often found volunteering at the local library or organizing neighborhood clean-up events. Their quiet demeanor hides a fierce dedication to improving their community and fostering education.', imgFamilyBio: 'https://placehold.co/400x200/3B82F6/ffffff?text=Jaleel+Household' },
      { householdName: 'Kahanani', funds: 17000, biography: 'Known for their strong family bonds and love for the ocean. The Kahanani family are master fishermen and storytellers, preserving ancient island legends. They spend most of their days by the water, living a peaceful life in harmony with nature.', imgFamilyBio: 'https://placehold.co/400x200/2563EB/ffffff?text=Kahanani' },
      { householdName: 'Keacha', funds: 9000, biography: 'A family of talented musicians and performers. They dream of forming a successful band and touring the world. Their garage is a makeshift recording studio, and their evenings are filled with jam sessions and songwriting. They are always ready to put on a show.', imgFamilyBio: 'https://placehold.co/400x200/1D4ED8/ffffff?text=Keacha+Family' },
      { householdName: 'Laurent family', funds: 35000, biography: 'A sophisticated family with a love for fine arts and culture. They are patrons of the arts, frequently hosting exclusive gallery openings and classical music concerts. Their lavish mansion is filled with priceless art pieces and rare antique furniture, reflecting their refined tastes.', imgFamilyBio: 'https://placehold.co/400x200/1E3A8A/ffffff?text=Laurent+Family' },
      { householdName: 'Linh household', funds: 11000, biography: 'A quiet and studious household, always seeking knowledge. The Linh family values education above all else, with every member dedicated to academic pursuits or scientific research. Their home library is vast, and intellectual discussions are a daily occurrence.', imgFamilyBio: 'https://placehold.co/400x200/172554/ffffff?text=Linh+Household' },
      { householdName: 'Linh-Sacya family', funds: 22000, biography: 'A blended family finding harmony and shared passions. The Linh-Sacya household has successfully merged two distinct backgrounds into a loving and supportive unit. They often combine their cultural traditions in unique and beautiful ways, creating a rich tapestry of experiences.', imgFamilyBio: 'https://placehold.co/400x200/0F172A/ffffff?text=Linh-Sacya+Family' },
      { householdName: 'Markovic family', funds: 14000, biography: 'Known for their culinary skills and delicious family recipes. The Markovics run a popular local diner, serving up comfort food with a secret family twist. They believe that food is love and their kitchen is the heart of their home, always bustling with activity.', imgFamilyBio: 'https://placehold.co/400x200/3B0764/ffffff?text=Markovic+Family' },
      { householdName: 'Michaelson family', funds: 28000, biography: 'A family of inventors and tech enthusiasts, always innovating. Their home is a workshop filled with half-finished gadgets and experimental robots. They are constantly trying to build the next big thing, often resulting in hilarious (and sometimes explosive) failures.', imgFamilyBio: 'https://placehold.co/400x200/EC4899/ffffff?text=Michaelson+Family' },
      { householdName: 'Munch', funds: 16000, biography: 'The lively Munch siblings, navigating life together in Windenburg. Mika, Lucas, and Elsa Munch are a tight-knit trio facing the challenges of adolescence and young adulthood. Despite their arguments, they always have each other\'s backs.', imgFamilyBio: 'https://placehold.co/400x200/DB2777/ffffff?text=Munch+Family' },
      { householdName: 'Ngala', funds: 19000, biography: 'A vibrant family with deep roots in their community. The Ngalas are known for their storytelling, music, and festive gatherings. They play an active role in local events, sharing their rich heritage and bringing joy to everyone around them.', imgFamilyBio: 'https://placehold.co/400x200/C026D3/ffffff?text=Ngala+Family' },
      { householdName: 'Pancakes family', funds: 7000, biography: 'Bob and Eliza Pancake, a couple with a complicated but endearing relationship. While Bob loves cooking and staying home, Eliza is ambitious and yearns for more. Their suburban home often feels like a battlefield of conflicting desires, but they secretly cherish their unique bond.', imgFamilyBio: 'https://placehold.co/400x200/6EE7B7/ffffff?text=Pancakes+Family' },
      { householdName: 'Partihaus', funds: 25000, biography: 'The ultimate party animals, always hosting the best gatherings in Windenburg. This household, led by the charismatic Ulrike Faust, believes life is meant to be celebrated. Their home is a perpetual party zone, with music, laughter, and Sims from all walks of life.', imgFamilyBio: 'https://placehold.co/400x200/9333EA/ffffff?text=Partihaus' },
      { householdName: 'Robles family', funds: 13000, biography: 'A family of nature lovers, dedicated to preserving the environment. They live off the grid as much as possible, tending to their large garden and advocating for sustainable living. Their home is a green oasis, filled with plants and the gentle hum of self-sufficiency.', imgFamilyBio: 'https://placehold.co/400x200/6D28D9/ffffff?text=Robles+Family' },
      { householdName: 'Roswell family', funds: 21000, biography: 'An enigmatic family with rumored alien connections. They moved to Oasis Springs under mysterious circumstances, and their behavior often raises eyebrows. They have an unusual affinity for stargazing and a peculiar diet, leading many to wonder about their true origins.', imgFamilyBio: 'https://placehold.co/400x200/4C1D95/ffffff?text=Roswell+Family' },
      { householdName: 'Sigworth family', funds: 10000, biography: 'A family of explorers, always seeking new adventures. They are rarely found at home, preferring to trek through jungles, uncover ancient ruins, and discover hidden worlds. Their lives are a continuous journey of discovery and thrill-seeking.', imgFamilyBio: 'https://placehold.co/400x200/3B0764/ffffff?text=Sigworth+Family' },
      { householdName: '8000 family', funds: 8000, biography: 'A modern family embracing technology and innovation. They are early adopters of every new gadget, and their home is a smart house run by AI. They believe technology holds the key to a better future, constantly upgrading their lives with the latest advancements.', imgFamilyBio: 'https://placehold.co/400x200/EC4899/ffffff?text=8000+Family' },
      { householdName: 'Spencer-Kim-Lewis family', funds: 40000, biography: 'A large, busy household with diverse personalities. Dennis Kim, Alice Spencer-Kim, and their children Olivia and Eric, along with Eric\'s parents, make for a lively, often chaotic, but loving home. Juggling careers, school, and family drama is their daily routine.', imgFamilyBio: 'https://placehold.co/400x200/DB2777/ffffff?text=Spencer-Kim-Lewis' },
      { householdName: 'Villareal', funds: 50000, biography: 'The wealthy and influential Villareal family, known for their elaborate home and a father with a penchant for mischief. Jacques Villareal and his children Hugo and Luna lead a life of luxury, but beneath the surface, family dynamics are complex and full of secrets. Their sprawling estate hosts many clandestine meetings.', imgFamilyBio: 'https://placehold.co/400x200/C026D3/ffffff?text=Villareal+Family' },
    ];
    return rawFamilyData.map((data, index) => ({
      id: `family-${index}`,
      name: data.householdName,
      description: data.biography || 'No biography available for this family yet.',
      funds: data.funds || 0,
      members: [],
      image: data.imgFamilyBio || `https://placehold.co/400x200/A0AEC0/ffffff?text=${encodeURIComponent(data.householdName)}+Family`,
    }));
  }, []);

  const filteredFamilyData = useMemo(() => {
    if (!searchTerm) return allFamiliesData;
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    return allFamiliesData.filter(family =>
      family.name.toLowerCase().includes(lowerCaseSearchTerm) ||
      family.description.toLowerCase().includes(lowerCaseSearchTerm)
    );
  }, [allFamiliesData, searchTerm]);

  const filteredNewsData = useMemo(() => {
    if (!searchTerm) return newsData;
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    return newsData.filter(article =>
      article.headline.toLowerCase().includes(lowerCaseSearchTerm) ||
      article.content.toLowerCase().includes(lowerCaseSearchTerm)
    );
  }, [newsData, searchTerm]);

  // Calculate alive population count
  const alivePopulationCount = useMemo(() => {
    return simsData.filter(sim => sim.status === 'Alive').length;
  }, [simsData]);


  const renderPage = () => {
    switch (currentPage) {
      case 'simBiographies':
        return <SimBiographies simsData={filteredSimsData} getMockSimsData={getMockSimsData} onExpand={handleOpenExpandedView} />;
      case 'familyBiographies':
        return <FamilyBiographies filteredFamilyData={filteredFamilyData} onExpand={handleOpenExpandedView} />; // Pass filtered data
      case 'neighborhoodNews':
        return <NeighborhoodNews newsData={filteredNewsData} onExpand={handleOpenExpandedView} />; // Pass filtered data
      case 'population':
        return <PopulationStats simsData={filteredSimsData} alivePopulationCount={alivePopulationCount} />; // Pass filtered data and count
      case 'notes':
        return <NotesSection />;
      default:
        return <SimBiographies simsData={filteredSimsData} getMockSimsData={getMockSimsData} onExpand={handleOpenExpandedView} />;
    }
  };

  // Determine search results to pass to SearchBar
  const currentSearchResults = useMemo(() => {
    if (searchType === 'sim') {
      return filteredSimsData.map(sim => ({ id: sim.id, fullName: sim.fullName, household: sim.household, item: sim }));
    } else if (searchType === 'family') {
      return filteredFamilyData.map(family => ({ id: family.id, name: family.name, item: family }));
    }
    return [];
  }, [searchType, filteredSimsData, filteredFamilyData]);


  return (
    <div className="min-h-screen bg-gray-100 font-sans antialiased text-gray-800">
      {/* Header */}
      <header className="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 shadow-lg">
        <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
          <h1 className="text-white text-3xl font-bold mb-2 sm:mb-0">Sims Neighborhood Portal</h1>
          <SearchBar
            onSearch={handleSearch}
            onToggleFullScreen={setIsSearchFullScreen}
            isFullScreen={isSearchFullScreen}
            searchResults={currentSearchResults}
            onResultClick={(result, type) => handleOpenExpandedView(result.item, type, (type === 'sim' ? filteredSimsData : filteredFamilyData), (type === 'sim' ? filteredSimsData : filteredFamilyData).findIndex(item => item.id === result.id))}
          />
        </div>
      </header>

      {/* Navigation */}
      <nav className="bg-white shadow-md py-3 sticky top-0 z-10">
        <div className="container mx-auto flex flex-wrap justify-center sm:justify-start gap-2 px-2">
          <NavLink onClick={() => handleNavigationClick('simBiographies')} isActive={currentPage === 'simBiographies'}>
            Sim Biographies
          </NavLink>
          <NavLink onClick={() => handleNavigationClick('familyBiographies')} isActive={currentPage === 'familyBiographies'}>
            Family Biographies
          </NavLink>
          <NavLink onClick={() => handleNavigationClick('neighborhoodNews')} isActive={currentPage === 'neighborhoodNews'}>
            Neighborhood News
          </NavLink>
          <NavLink onClick={() => handleNavigationClick('population')} isActive={currentPage === 'population'}>
            Population
          </NavLink>
          <NavLink onClick={() => handleNavigationClick('notes')} isActive={currentPage === 'notes'}>
            Notes
          </NavLink>
        </div>
      </nav>

      {/* Main Content Area */}
      <main className="container mx-auto p-4 py-8">
        {renderPage()}
      </main>

      {/* Expanded View Modal */}
      {expandedItem && (
        <ExpandedViewModal
          item={expandedItem.item}
          type={expandedItem.type}
          allItems={expandedItem.allItems}
          currentIndex={expandedItem.currentIndex}
          onClose={handleCloseExpandedView}
          onNavigate={handleOpenExpandedView} // Pass the navigation function
        />
      )}

      {/* Footer */}
      <footer className="bg-gray-800 text-white p-4 text-center text-sm mt-8">
        <div className="container mx-auto">
          &copy; {new Date().getFullYear()} Sims Neighborhood Portal. All rights reserved.
        </div>
      </footer>
    </div>
  );
};

// Reusable Navigation Link Component
const NavLink = ({ children, onClick, isActive }) => (
  <button
    onClick={onClick}
    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ease-in-out
      ${isActive
        ? 'bg-blue-500 text-white shadow-lg'
        : 'text-gray-700 hover:bg-gray-200 hover:text-blue-600'
      }`}
  >
    {children}
  </button>
);

// --- Expanded View Modal Component ---
const ExpandedViewModal = ({ item, type, allItems, currentIndex, onClose, onNavigate }) => {
  const [fullScreenImage, setFullScreenImage] = useState(null);
  const [currentImageIndex, setCurrentImageIndex] = useState(0); // For image carousel within modal

  // Reset image index when item changes
  useEffect(() => {
    setCurrentImageIndex(0);
  }, [item]);

  if (!item) return null;

  let title = '';
  let mainContent = null;
  let imagesForDisplay = []; // Images for the internal carousel/gallery within the modal
  let enableContentNavigation = false; // For News articles

  if (type === 'sim') {
    title = `${item.firstName} ${item.name}`;
    mainContent = (
      <div className="space-y-4 text-gray-800 text-base leading-relaxed">
        <p className="text-lg font-normal mb-4">{item.bio || 'No biography available.'}</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><span className="font-semibold">Career:</span> {item.career || 'N/A'} (Level {item.careerLvl || 'N/A'})</div>
          <div><span className="font-semibold">Aspiration:</span> {item.aspirationSims4 || item.aspiration || 'N/A'}</div>
          <div><span className="font-semibold">Zodiac:</span> {item.zodiac || 'N/A'}</div>
          <div><span className="font-semibold">Favorite Food:</span> {item.favoriteFood || 'N/A'}</div>
          <div><span className="font-semibold">Marital Status:</span> {item.maritalStatus || 'N/A'}</div>
          {item.occultStatus && item.occultStatus !== 'None' && <div><span className="font-semibold">Occult:</span> {item.occultStatus}</div>}
        </div>
        {item.traits && item.traits.length > 0 && (
          <div>
            <h4 className="font-semibold text-gray-800 text-base mb-1">Traits:</h4>
            <div className="flex flex-wrap gap-1 text-sm text-gray-700">
              {item.traits.map((trait, index) => (
                <span key={index} className="bg-gray-100 px-2 py-0.5 rounded-full">{trait}</span>
              ))}
            </div>
          </div>
        )}
        {item.notes && (
          <div>
            <h4 className="font-semibold text-gray-800 text-base mb-1">Notes:</h4>
            <p className="text-sm text-gray-700 italic">{item.notes}</p>
          </div>
        )}
        {/* Relations */}
        { (item.partners && item.partners.length > 0) || (item.siblings && item.siblings.length > 0) || (item.children && item.children.length > 0) ? (
          <div>
            <h4 className="font-semibold text-gray-800 text-base mb-1">Relationships:</h4>
            {item.partners && item.partners.length > 0 && <p className="text-sm text-gray-700"><span className="font-semibold">Partners:</span> {item.partners.join(', ')}</p>}
            {item.siblings && item.siblings.length > 0 && <p className="text-sm text-gray-700"><span className="font-semibold">Siblings:</span> {item.siblings.join(', ')}</p>}
            {item.children && item.children.length > 0 && <p className="text-sm text-gray-700"><span className="font-semibold">Children:</span> {item.children.join(', ')}</p>}
          </div>
        ) : null}
      </div>
    );
    imagesForDisplay = [
      item.imageYoungAdult, item.imageAdult, item.imageTeen,
      item.imageChild, item.imageToddler, item.imageBaby, item.imageElder
    ].filter(Boolean);
  } else if (type === 'family') {
    title = item.name;
    mainContent = (
      <div className="space-y-4 text-gray-800 text-base leading-relaxed">
        <p className="text-lg font-normal mb-4">{item.description || 'No biography available.'}</p>
        <div className="text-base text-gray-700 mb-3">
          <span className="font-semibold">Household Funds:</span> §{item.funds.toLocaleString()}
        </div>
        {item.members && item.members.length > 0 && (
          <div>
            <h4 className="font-semibold text-gray-800 text-base mb-1">Members:</h4>
            <ul className="list-disc list-inside text-base text-gray-700">
              {item.members.map((member, index) => (
                <li key={index}>{member}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    );
    imagesForDisplay = [item.image].filter(Boolean);
  } else if (type === 'news') {
    title = item.title;
    mainContent = (
      <div className="space-y-4 text-gray-800 text-base leading-relaxed">
        <p className="text-base text-gray-500 mb-3">{item.date}</p>
        <p className="text-lg font-normal leading-relaxed">{item.content || 'No content available.'}</p>
      </div>
    );
    imagesForDisplay = [item.image].filter(Boolean);
    enableContentNavigation = true; // Enable article navigation for news
  }

  const openFullScreenImage = (src) => {
    setFullScreenImage(src);
  };

  const closeFullScreenImage = () => {
    setFullScreenImage(null);
  };

  // Handlers for image carousel within Sim/Family/News modal
  const handlePrevImage = (e) => {
    e.stopPropagation(); // Prevent modal close
    setCurrentImageIndex((prevIndex) => (prevIndex === 0 ? imagesForDisplay.length - 1 : prevIndex - 1));
  };

  const handleNextImage = (e) => {
    e.stopPropagation(); // Prevent modal close
    setCurrentImageIndex((prevIndex) => (prevIndex === imagesForDisplay.length - 1 ? 0 : prevIndex + 1));
  };

  // Handlers for news article navigation
  const handlePrevContent = (e) => {
    e.stopPropagation(); // Prevent modal close
    const prevIndex = (currentIndex === 0 ? allItems.length - 1 : currentIndex - 1);
    onNavigate(allItems[prevIndex], type, allItems, prevIndex);
  };

  const handleNextContent = (e) => {
    e.stopPropagation(); // Prevent modal close
    const nextIndex = (currentIndex === allItems.length - 1 ? 0 : currentIndex + 1);
    onNavigate(allItems[nextIndex], type, allItems, nextIndex);
  };


  return (
    <div
      className="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center p-4 z-50 overflow-y-auto"
      onClick={onClose} // Close modal when clicking outside
    >
      <div
        className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto flex flex-col"
        onClick={(e) => e.stopPropagation()} // Prevent closing when clicking inside the modal content
      >
        {/* Modal Header */}
        <div className="p-5 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
          <h2 className="text-2xl font-bold text-gray-900">{title}</h2>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none"
            aria-label="Close modal"
          >
            &times;
          </button>
        </div>

        {/* Modal Body - Main Content */}
        <div className="p-5 flex-grow">
          {/* Main Image (with carousel for multiple images) */}
          {imagesForDisplay.length > 0 && (
            <div className="mb-4 flex flex-col items-center">
              <div className="relative w-full max-w-sm mx-auto">
                <img
                  src={imagesForDisplay[currentImageIndex]}
                  alt={`${title} image`}
                  className="w-full h-auto rounded-lg shadow-md cursor-pointer mb-2"
                  onClick={() => openFullScreenImage(imagesForDisplay[currentImageIndex])}
                  onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x200/E2E8F0/ffffff?text=Image'; }}
                />
                {imagesForDisplay.length > 1 && (
                  <>
                    <button
                      onClick={handlePrevImage}
                      className="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                      aria-label="Previous image"
                    >
                      &#10094;
                    </button>
                    <button
                      onClick={handleNextImage}
                      className="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                      aria-label="Next image"
                    >
                      &#10095;
                    </button>
                  </>
                )}
              </div>
            </div>
          )}

          {mainContent}

          {/* Navigation for News Articles (Previous/Next) - only for news type and multiple items */}
          {enableContentNavigation && allItems && allItems.length > 1 && (
            <div className="flex justify-between mt-6 border-t pt-4">
              <button
                onClick={handlePrevContent}
                className="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled={currentIndex === 0}
              >
                &#9664; Previous
              </button>
              <button
                onClick={handleNextContent}
                className="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled={currentIndex === allItems.length - 1}
              >
                Next &#9654;
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Full-screen Image Overlay */}
      {fullScreenImage && (
        <div
          className="fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-[60]"
          onClick={closeFullScreenImage}
        >
          <img
            src={fullScreenImage}
            alt="Full screen view"
            className="max-w-[90%] max-h-[90%] object-contain rounded-lg shadow-xl"
            onClick={(e) => e.stopPropagation()} // Prevent closing when clicking on the image itself
          />
          <button
            onClick={closeFullScreenImage}
            className="absolute top-4 right-4 text-white text-5xl font-light leading-none z-highest"
            aria-label="Close full screen image"
          >
            &times;
          </button>
        </div>
      )}
    </div>
  );
};


// --- Sim Biographies Section ---
const SimBiographies = ({ simsData, getMockSimsData, onExpand }) => {
  // Determine which data to display: fetched data if available and not empty, otherwise mock data.
  const dataToDisplay = simsData && simsData.length > 0 ? simsData : getMockSimsData();

  return (
    <section className="bg-white p-6 rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Sim Biographies</h2>
      <p className="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
        Explore the detailed lives of your Sims neighborhood residents. Click on a Sim's card to imagine more details!
      </p>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {dataToDisplay.map((sim, index) => ( // Pass index to SimCard for navigation within modal
          <SimCard key={sim.id || `${sim.firstName}-${sim.name}`} sim={sim} onExpand={onExpand} allSims={dataToDisplay} simIndex={index} />
        ))}
      </div>
    </section>
  );
};

// Component to display an individual Sim's card
const SimCard = ({ sim, onExpand, allSims, simIndex }) => {
  const [currentLifeStageImage, setCurrentLifeStageImage] = useState('');

  // Map age string to corresponding image property
  const getInitialImage = (sim) => {
    const ageImages = {
      'Baby': sim.imageBaby,
      'Toddler': sim.imageToddler,
      'Child': sim.imageChild,
      'Teen': sim.imageTeen,
      'Young Adult': sim.imageYoungAdult,
      'Adult': sim.imageAdult,
      'Elder': sim.imageElder,
    };
    return ageImages[sim.age] || sim.imageYoungAdult || 'https://placehold.co/200x250/A0AEC0/ffffff?text=No+Image';
  };

  useEffect(() => {
    setCurrentLifeStageImage(getInitialImage(sim));
  }, [sim]);

  // Define life stages and their corresponding image keys
  const lifeStages = [
    { label: 'Baby', key: 'imageBaby', ageString: 'Baby' },
    { label: 'Toddler', key: 'imageToddler', ageString: 'Toddler' },
    { label: 'Child', key: 'imageChild', ageString: 'Child' },
    { label: 'Teen', key: 'imageTeen', ageString: 'Teen' },
    { label: 'Young Adult', key: 'imageYoungAdult', ageString: 'Young Adult' },
    { label: 'Adult', key: 'imageAdult', ageString: 'Adult' },
    { label: 'Elder', key: 'imageElder', ageString: 'Elder' },
  ];

  // Helper to ensure 'traits' is an array, handling various input formats
  const allTraits = Array.isArray(sim.traits)
    ? sim.traits.filter(Boolean)
    : [
        sim.traits,
        sim.trait2,
        sim.trait3,
        sim.trait4,
        sim.trait5,
        sim.bonusTrait,
      ].flat().filter(Boolean);


  return (
    <div
      className="bg-white border border-gray-200 rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 cursor-pointer"
      onClick={() => onExpand(sim, 'sim', allSims, simIndex)} // Pass allSims and simIndex for navigation
    >
      <div className="relative">
        <img
          src={currentLifeStageImage}
          alt={`${sim.firstName || ''} ${sim.name || ''}`}
          className="w-full h-64 object-cover object-center rounded-t-xl"
          onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/200x250/A0AEC0/ffffff?text=No+Image'; }}
        />
        <div className="absolute bottom-0 left-0 bg-gradient-to-t from-black via-black/70 to-transparent p-4 w-full">
          <h3 className="text-xl font-bold text-white leading-tight">
            {sim.firstName || 'Unknown'} {sim.name || 'Sim'}
          </h3>
          <p className="text-sm text-gray-300">{sim.title || 'N/A'}</p>
        </div>
      </div>

      <div className="p-4 space-y-4">
        {/* Quick Info Badges */}
        <div className="flex flex-wrap gap-2 text-xs font-semibold">
          <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{sim.age || 'N/A'}</span>
          <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full">{sim.gender || 'N/A'}</span>
          <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">{sim.maritalStatus || 'N/A'}</span>
          {sim.occultStatus && sim.occultStatus !== 'None' && (
            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">{sim.occultStatus}</span>
          )}
        </div>

        {/* Short Bio */}
        <p className="text-sm text-gray-700">
          {(sim.bio || 'No biography available.').substring(0, 150)}{((sim.bio || '').length > 150) ? '...' : ''}
        </p>

        {/* Life Stage Buttons */}
        <div className="border-t border-gray-200 pt-4 mt-4">
          <h4 className="font-semibold text-gray-800 text-sm mb-2">View by Age:</h4>
          <div className="flex flex-wrap gap-2 justify-center">
            {lifeStages.map((stage) => {
              const imageSrc = sim[stage.key];
              // Render button only if imageSrc exists for that stage
              return imageSrc ? (
                <button
                  key={stage.key}
                  onClick={(e) => {
                    e.stopPropagation(); // Prevent card from expanding when clicking age button
                    setCurrentLifeStageImage(imageSrc);
                  }}
                  className={`p-1 rounded-full overflow-hidden shadow-md transition-all duration-200 ease-in-out
                    ${currentLifeStageImage === imageSrc ? 'ring-2 ring-blue-500 transform scale-110' : 'hover:scale-105'}`
                  }
                  title={stage.label}
                >
                  <img
                    src={imageSrc}
                    alt={stage.label}
                    className="w-10 h-10 rounded-full object-cover"
                    onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/40x40/E2E8F0/ffffff?text=' + stage.label.substring(0,1); }}
                  />
                </button>
              ) : null; // Do not render button if no image for that stage
            })}
          </div>
        </div>
      </div>
    </div>
  );
};


// --- Family Biographies Section ---
const FamilyBiographies = ({ filteredFamilyData, onExpand }) => { // Accept filteredFamilyData prop
  // Transform raw data to match component's expected structure
  const families = filteredFamilyData.map((data, index) => ({
    id: `family-${index}`, // Generate a unique ID
    name: data.householdName,
    description: data.biography || 'No biography available for this family yet.', // Default text if empty
    funds: data.funds || 0, // Default to 0 if no funds specified
    // For now, members will be generic. In a real app, you'd link this to Sim data.
    members: [], // Placeholder for members (could be added manually or from another CSV later)
    image: data.imgFamilyBio || `https://placehold.co/400x200/A0AEC0/ffffff?text=${encodeURIComponent(data.householdName)}+Family`,
  }));

  return (
    <section className="bg-white p-6 rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Family Biographies</h2>
      <p className="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
        Discover the histories and dynamics of the prominent families living in your Sims neighborhood. Click on a family card for more details!
      </p>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {families.map((family, index) => (
          <div
            key={family.id}
            className="bg-gray-50 border border-gray-200 rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow duration-300 cursor-pointer"
            onClick={() => onExpand(family, 'family', families, index)} // Pass family data, type, all families, and index to expand
          >
            <img
              src={family.image}
              alt={`${family.name} banner`}
              className="w-full h-40 object-cover object-center rounded-t-xl"
              onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x200/A0AEC0/ffffff?text=Family+Image'; }}
            />
            <div className="p-4">
              <h3 className="text-xl font-bold text-gray-900 mb-2">{family.name}</h3>
              <p className="text-sm text-gray-700 mb-3">{family.description.substring(0, 100)}{family.description.length > 100 ? '...' : ''}</p>
              <div className="text-sm text-gray-600 mb-3">
                <span className="font-semibold">Funds:</span> §{family.funds.toLocaleString()} {/* Format funds */}
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>
  );
};

// --- Neighborhood News Section ---
const NeighborhoodNews = ({ newsData, onExpand }) => { // Accept newsData prop
  // Use newsData directly, or fallback to mock if empty
  const articlesToDisplay = newsData && newsData.length > 0 ? newsData : getMockNewsData();


  return (
    <section className="bg-white p-6 rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Neighborhood News</h2>
      <p className="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
        Stay updated with the latest happenings, gossip, and bizarre events from across your Sims neighborhood!
      </p>

      <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
        {articlesToDisplay.map((article, index) => {
          // Use parsed content and image from article object directly
          const displayContent = article.content || 'No content available.';
          const displayImage = article.image || 'https://placehold.co/600x300/A0AEC0/ffffff?text=News+Image';

          return (
            <div
              key={article.id}
              className="bg-gray-50 border border-gray-200 rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow duration-300 cursor-pointer"
              onClick={() => onExpand(article, 'news', articlesToDisplay, index)} // Pass article data, type, all articles, and index to expand
            >
              <img
                src={displayImage}
                alt={article.title}
                className="w-full h-48 object-cover rounded-t-xl"
                onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/600x300/A0AEC0/ffffff?text=News+Image'; }}
              />
              <div className="p-4">
                <h3 className="text-xl font-bold text-gray-900 mb-2">{article.title}</h3>
                <p className="text-sm text-gray-500 mb-2">{article.date}</p>
                <p className="text-gray-700 text-sm">{displayContent.substring(0, 100)}{displayContent.length > 100 ? '...' : ''}</p>
              </div>
            </div>
          );
        })}
      </div>
    </section>
  );
};

// --- Population Stats Section ---
// Now accepts simsData as a prop
const PopulationStats = ({ simsData, alivePopulationCount }) => { // Accept alivePopulationCount prop
  // Use the simsData directly for rendering the table
  const dataToDisplay = simsData && simsData.length > 0 ? simsData : getMockSimsData(); // Fallback to mock data if fetched is empty or null

  return (
    <section className="bg-white p-6 rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Population: {alivePopulationCount}</h2>
      <p className="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
        A detailed look at each Sim in your neighborhood who is currently alive, including their household, age, gender, aspirations, and status.
      </p>

      <div className="overflow-x-auto rounded-lg shadow-md">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Name
              </th>
              <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Household
              </th>
              <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Age
              </th>
              <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Gender
              </th>
              <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Aspiration
              </th>
              <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {dataToDisplay.map((sim, index) => ( // Use dataToDisplay here
              <tr key={sim.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {sim.fullName || `${sim.firstName || 'N/A'} ${sim.name || 'N/A'}`} {/* Use fullName here */}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {sim.household || 'N/A'} {/* Assuming 'household' field exists in CSV data */}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {sim.age || 'N/A'}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {sim.gender || 'N/A'}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {sim.aspirationSims4 || sim.aspiration || 'N/A'} {/* Prioritize Sims4 aspiration */}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {sim.status || 'N/A'}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  );
};

// --- Notes Section ---
const NotesSection = () => {
  const creatorNotes = [
    {
      id: 'cn-1',
      title: 'Current Storylines in Progress',
      content: 'Focusing on the Bella Goth abduction storyline this cycle. Also, planning a major career event for Cassandra Goth. Need to introduce a new rival for Mortimer in the science field.',
    },
    {
      id: 'cn-2',
      title: 'Future Generations Planning',
      content: 'Considering a new generation of Caliente twins. How will the Pleasants react to their children growing up?',
    },
  ];

  const characterNotes = [
    {
      id: 'char-1',
      sim: 'Bella Goth',
      content: 'Found a strange device in Mortimer\'s study. What is he really working on? Feeling a strong urge to travel somewhere new...',
    },
    {
      id: 'char-2',
      sim: 'Mortimer Goth',
      content: 'My latest experiment requires more rare earth elements. The local supplier is running low. Perhaps a trip to Sixam is in order.',
    },
    {
      id: 'char-3',
      sim: 'Cassandra Goth',
      content: 'My music isn\'t appreciated enough here. Maybe a move to Oasis Springs would inspire me. Geoffrey Landgraab keeps sending me anonymous flowers... weird.',
    },
  ];

  return (
    <section className="bg-white p-6 rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Neighborhood Notes</h2>
      <p className="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
        Keep track of creator-specific thoughts, plans, and in-character notes for your Sims neighborhood.
      </p>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Creator Notes */}
        <div>
          <h3 className="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Creator Notes</h3>
          <div className="space-y-4">
            {creatorNotes.map((note) => (
              <div key={note.id} className="bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                <h4 className="font-bold text-gray-900 mb-1">{note.title}</h4>
                <p className="text-sm text-gray-700">{note.content}</p>
              </div>
            ))}
          </div>
        </div>

        {/* Character Notes */}
        <div>
          <h3 className="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">In-Character Notes</h3>
          <div className="space-y-4">
            {characterNotes.map((note) => (
              <div key={note.id} className="bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                <h4 className="font-bold text-gray-900 mb-1">From: {note.sim}</h4>
                <p className="text-sm text-gray-700 italic">"{note.content}"</p>
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>
  );
};

export default App;
