<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sims Notes!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base color variables for Light Mode (default) */
        :root {
            --bg-primary: #f8f9fa; /* Wikipedia's light gray background */
            --text-primary: #202122; /* Wikipedia's dark text */
            --link-color: #3366cc; /* Wikipedia's standard blue link */
            --link-hover-color: #204080; /* Darker blue on hover */
            --border-color: #a2a9b1; /* Wikipedia's light border gray */
            --card-bg: #ffffff; /* White card background */
            --header-bg: #eaecf0; /* Wikipedia's section header gray */
            --button-bg: #eaecf0; /* Light button background */
            --button-text: #202122; /* Dark text on buttons */
            --button-hover-bg: #e0e3e7; /* Slightly darker button on hover */
            --table-header-bg: #eaecf0;
            --sim-card-bg: #f2f2f2; /* Light gray for sim cards */
            --story-card-bg: #f2f2f2; /* Light gray for story cards */
        }

        /* Dark Mode variables */
        body.dark-mode {
            --bg-primary: #2c2c2c; /* Dark gray background */
            --text-primary: #e0e0e0; /* Light gray text */
            --link-color: #7abeff; /* Lighter blue link */
            --link-hover-color: #a2d2ff; /* Even lighter blue on hover */
            --border-color: #555555; /* Darker border gray */
            --card-bg: #3c3c3c; /* Dark card background */
            --header-bg: #4c4c4c; /* Darker section header */
            --button-bg: #4c4c4c; /* Dark button background */
            --button-text: #e0e0e0; /* Light text on buttons */
            --button-hover-bg: #5c5c5c; /* Slightly lighter button on hover */
            --table-header-bg: #4c4c4c;
            --sim-card-bg: #383838; /* Darker gray for sim cards */
            --story-card-bg: #383838; /* Darker gray for story cards */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar {
            width: 280px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .main-content {
            background-color: var(--bg-primary);
            transition: background-color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header-bg {
            background-color: var(--header-bg);
            transition: background-color 0.3s;
        }

        .list-item-hover:hover {
            background-color: var(--button-hover-bg);
        }

        .button {
            background-color: var(--button-bg);
            color: var(--button-text);
            transition: background-color 0.3s, color 0.3s;
        }

        .button:hover {
            background-color: var(--button-hover-bg);
        }

        .table-header {
            background-color: var(--table-header-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .sim-card, .story-card {
            background-color: var(--sim-card-bg); /* Use specific variable for sim cards */
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Active state for sidebar items */
        .family-item.active, .sim-item.active {
            background-color: var(--link-color) !important;
            color: white !important;
        }

        .family-item.active .text-gray-600, .sim-item.active .text-gray-600 {
            color: white !important; /* Ensure sub-text is also white */
        }

        .family-item.active .expand-icon {
            color: white !important; /* Ensure expand icon is also white */
        }

        /* Ensure links within content also respect dark mode */
        .main-content a {
            color: var(--link-color);
        }
        .main-content a:hover {
            color: var(--link-hover-color);
        }

        /* Specific styles for chart canvas if needed */
        canvas {
            background-color: var(--card-bg); /* Chart background */
            border-radius: 0.5rem; /* Match card styling */
            padding: 1rem;
        }

    </style>
</head>
<body class="flex h-screen antialiased">
    <div class="sidebar flex-shrink-0 p-4">
        <h1 class="text-2xl font-bold mb-6 text-center">My Sims Notes!</h1>

        <div class="mb-6">
            <input type="text" id="searchBar" onkeyup="filterFamilyList()" placeholder="Search families or Sims..."
                   class="w-full p-2 rounded-md bg-gray-200 dark:bg-gray-700 text-text-primary border border-border-color focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="familyList" class="space-y-2">
            </div>

        <div id="homelessSimsSection" class="mt-4">
            <div class="flex justify-between items-center px-2 py-2 rounded-md cursor-pointer hover:bg-button-hover-bg"
                 onclick="toggleHomelessSims()">
                <span class="font-semibold text-text-primary">Homeless Sims</span>
                <i id="homelessExpandIcon" class="fas fa-chevron-right expand-icon text-gray-600"></i>
            </div>
            <div id="homelessSimsList" class="pl-4 mt-2 hidden space-y-1">
                </div>
        </div>
    </div>

    <div class="main-content flex-1 flex flex-col">
        <div class="flex-shrink-0 bg-card-bg border-b border-border-color p-4 flex justify-between items-center">
            <h2 id="contentTitle" class="text-xl font-semibold text-text-primary">Welcome!</h2>
            <button id="themeToggle" class="button px-4 py-2 rounded-md">Toggle Theme</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <div id="welcomeSection" class="content-section card p-6">
                <h3 class="text-lg font-bold mb-4 text-text-primary">About This World</h3>
                <div id="worldInfoDisplay" class="text-text-primary">
                    <p>Loading world information...</p>
                </div>
            </div>

            <div id="familyOverviewSection" class="content-section card p-6 hidden">
                <h3 id="familyOverviewTitle" class="text-xl font-bold mb-4 text-text-primary"></h3>
                <p id="familyOverviewBio" class="mb-4 text-text-primary"></p>
                <h4 class="text-lg font-semibold mb-3 text-text-primary">Family Members</h4>
                <div id="familyMembersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>

            <div id="simDetailsSection" class="content-section card p-6 hidden">
                <div class="flex items-center mb-4">
                    <img id="simPortrait" src="https://via.placeholder.com/80" alt="Sim Portrait" class="w-20 h-20 rounded-full mr-4 object-cover">
                    <div>
                        <h3 id="simName" class="text-2xl font-bold text-text-primary"></h3>
                        <p id="simPronouns" class="text-md text-gray-600 dark:text-gray-400"></p>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-text-primary"><span class="font-semibold">Age:</span> <span id="simAge"></span></p>
                    <p class="text-text-primary"><span class="font-semibold">Gender:</span> <span id="simGender"></span></p>
                    <p class="text-text-primary"><span class="font-semibold">Sexuality:</span> <span id="simSexuality"></span></p>
                    <p class="text-text-primary"><span class="font-semibold">Occupation:</span> <span id="simOccupation"></span></p>
                    <p class="text-text-primary"><span class="font-semibold">Aspiration:</span> <span id="simAspiration"></span></p>
                    <p class="text-text-primary"><span class="font-semibold">Traits:</span> <span id="simTraits"></span></p>
                    <p class="text-text-primary"><span class="font-semibold">Skills:</span> <span id="simSkills"></span></p>
                </div>

                <h4 class="text-lg font-semibold mb-3 text-text-primary">Biography</h4>
                <p id="simBiography" class="mb-4 text-text-primary"></p>

                <h4 class="text-lg font-semibold mb-3 text-text-primary">Relationships</h4>
                <ul id="simRelationships" class="list-disc list-inside mb-4 text-text-primary">
                    </ul>

                <h4 class="text-lg font-semibold mb-3 text-text-primary">Skills Progression</h4>
                <canvas id="simSkillsChart"></canvas>
            </div>

            <div id="neighborhoodStoriesSection" class="content-section card p-6 hidden">
                <h3 class="text-lg font-bold mb-4 text-text-primary">Neighborhood Stories</h3>
                <div id="storiesContainer" class="space-y-4">
                    </div>
            </div>

        </div>
    </div>

    <script>
        // Global data variables
        let simData = {}; // Will store family data and member details
        let worldInfo = {};
        let neighborhoodStories = [];
        let currentSelectedFamily = null;
        let currentSelectedSim = null;
        let simSkillsChartInstance = null; // To manage the Chart.js instance

        // CSV URLs
        const csvUrls = {
            worldInfo: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSs1l3tUbLZpKfZCUxSkdYYsRcneV_PsoF7yPLJ3YdZr_tsVSOo3qcH4idIjwmx-f4U7rMb7_nBDSuV/pub?gid=1046330091&single=true&output=csv',
            simBiography: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSs1l3tUbLZpKfZCUxSkdYYsRcneV_PsoF7yPLJ3YdZr_tsVSOo3qcH4idIjwmx-f4U7rMb7_nBDSuV/pub?gid=522782907&single=true&output=csv',
            familyBiography: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSs1l3tUbLZpKfZCUxSkdYYsRcneV_PsoF7yPLJ3YdZr_tsVSOo3qcH4idIjwmx-f4U7rMb7_nBDSuV/pub?gid=75505924&single=true&output=csv',
            neighborhoodStories: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSs1l3tUbLZpKfZCUxSkdYYsRcneV_PsoF7yPLJ3YdZr_tsVSOo3qcH4idIjwmx-f4U7rMb7_nBDSuV/pub?gid=1540825772&single=true&output=csv'
        };

        // Helper function to parse CSV text into an array of objects
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue;
                }
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index].trim();
                });
                data.push(row);
            }
            return data;
        }

        // Function to load all data from CSVs
        async function loadAllData() {
            try {
                // Fetch all CSVs concurrently
                const [worldInfoCsv, simBioCsv, familyBioCsv, neighborhoodStoriesCsv] = await Promise.all([
                    fetch(csvUrls.worldInfo).then(res => res.text()),
                    fetch(csvUrls.simBiography).then(res => res.text()),
                    fetch(csvUrls.familyBiography).then(res => res.text()),
                    fetch(csvUrls.neighborhoodStories).then(res => res.text())
                ]);

                // Parse CSV data
                const parsedWorldInfo = parseCSV(worldInfoCsv);
                const parsedSimBio = parseCSV(simBioCsv);
                const parsedFamilyBio = parseCSV(familyBioCsv);
                const parsedNeighborhoodStories = parseCSV(neighborhoodStoriesCsv);

                // Populate worldInfo
                worldInfo = parsedWorldInfo.reduce((acc, row) => {
                    if (row.Key && row.Value) {
                        acc[row.Key] = row.Value;
                    }
                    return acc;
                }, {});

                // Populate simData with family and sim biographies
                simData = {
                    homelessSims: { members: [] } // Initialize homeless sims
                };

                // Add family biographies first
                parsedFamilyBio.forEach(family => {
                    if (family.FamilyName) {
                        simData[family.FamilyName] = {
                            bio: family.Biography || '',
                            members: []
                        };
                    }
                });

                // Add sim biographies
                parsedSimBio.forEach(sim => {
                    const familyName = sim.Family || 'Homeless'; // Assume 'Homeless' if no family specified
                    const simObject = {
                        name: sim.Name,
                        portrait: sim.Portrait || 'https://via.placeholder.com/80', // Default portrait
                        pronouns: sim.Pronouns || 'They/Them',
                        age: sim.Age || '',
                        gender: sim.Gender || '',
                        sexuality: sim.Sexuality || '',
                        occupation: sim.Occupation || '',
                        aspiration: sim.Aspiration || '',
                        traits: sim.Traits ? sim.Traits.split(';').map(t => t.trim()) : [],
                        skills: sim.Skills ? sim.Skills.split(';').map(s => {
                            const [skillName, skillLevel] = s.split(':').map(part => part.trim());
                            return { name: skillName, level: parseInt(skillLevel) || 0 };
                        }) : [],
                        biography: sim.Biography || '',
                        relationships: sim.Relationships ? sim.Relationships.split(';').map(r => r.trim()) : []
                    };

                    if (familyName === 'Homeless') {
                        simData.homelessSims.members.push(simObject);
                    } else {
                        if (!simData[familyName]) {
                            // Create family if it wasn't in family biography, but a sim references it
                            simData[familyName] = { bio: `A family of ${familyName}.`, members: [] };
                        }
                        simData[familyName].members.push(simObject);
                    }
                });

                // Populate neighborhoodStories
                neighborhoodStories = parsedNeighborhoodStories.map(story => ({
                    title: story.Title,
                    description: story.Description,
                    date: story.Date,
                    image: story.Image || ''
                }));


                console.log("Data loaded successfully:", { worldInfo, simData, neighborhoodStories });

                // Initialize UI after data is loaded
                initializeUI();

            } catch (error) {
                console.error("Failed to load data:", error);
                document.getElementById('worldInfoDisplay').innerHTML = '<p class="text-red-500">Failed to load world information. Please ensure CSV links are correct and accessible.</p>';
            }
        }

        function initializeUI() {
            // Apply initial theme based on localStorage
            applyTheme(localStorage.getItem('theme') || 'light');
            
            // Populate World Information Section
            const worldInfoDisplay = document.getElementById('worldInfoDisplay');
            worldInfoDisplay.innerHTML = ''; // Clear loading message
            for (const key in worldInfo) {
                worldInfoDisplay.innerHTML += `<p><span class="font-semibold">${key}:</span> ${worldInfo[key]}</p>`;
            }

            updateFamilyList(); // Populate the sidebar
            hideAllContentSections();
            document.getElementById('welcomeSection').classList.remove('hidden'); // Show welcome section by default
            document.getElementById('contentTitle').textContent = 'Welcome!';
        }


        function hideAllContentSections() {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
        }

        function updateFamilyList(searchTerm = '') {
            const familyListDiv = document.getElementById('familyList');
            familyListDiv.innerHTML = ''; // Clear current list

            const allFamilyNames = Object.keys(simData).filter(key => key !== "homelessSims"); // Exclude homeless for now

            // Sort families alphabetically
            allFamilyNames.sort((a, b) => a.localeCompare(b));

            allFamilyNames.forEach(familyName => {
                const family = simData[familyName];
                const familyBio = family.bio || 'No biography available.';
                const membersCount = family.members ? family.members.length : 0;

                // Filter based on search term
                const matchesSearch = familyName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      familyBio.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      (family.members && family.members.some(sim => sim.name.toLowerCase().includes(searchTerm.toLowerCase())));

                if (matchesSearch) {
                    const familyItem = document.createElement('div');
                    familyItem.className = `family-item px-2 py-2 rounded-md cursor-pointer list-item-hover ${currentSelectedFamily === familyName ? 'active' : ''}`;
                    familyItem.innerHTML = `
                        <div class="flex justify-between items-center" onclick="toggleFamilyMembers('${familyName}')">
                            <span class="font-semibold text-text-primary">${familyName}</span>
                            <i id="expandIcon-${familyName}" class="fas fa-chevron-right expand-icon text-gray-600"></i>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${membersCount} member(s)</p>
                        <div id="membersList-${familyName}" class="pl-4 mt-2 ${currentSelectedFamily === familyName ? '' : 'hidden'} space-y-1">
                            </div>
                    `;
                    familyListDiv.appendChild(familyItem);

                    const membersListDiv = document.getElementById(`membersList-${familyName}`);
                    if (family.members) {
                        // Sort members alphabetically by name
                        family.members.sort((a, b) => a.name.localeCompare(b.name));
                        family.members.forEach(sim => {
                            const simItem = document.createElement('div');
                            simItem.className = `sim-item px-2 py-1 rounded-md cursor-pointer list-item-hover text-text-primary ${currentSelectedSim && currentSelectedSim.name === sim.name ? 'active' : ''}`;
                            simItem.textContent = sim.name;
                            simItem.onclick = (event) => {
                                event.stopPropagation(); // Prevent toggling family when clicking sim
                                selectSim(sim.name);
                            };
                            membersListDiv.appendChild(simItem);
                        });
                    }

                    // Adjust expand icon if family is currently expanded
                    if (currentSelectedFamily === familyName) {
                        const expandIcon = document.getElementById(`expandIcon-${familyName}`);
                        if (expandIcon) expandIcon.style.transform = 'rotate(90deg)';
                    }
                }
            });

            // Update homeless sims section based on search term
            const homelessSection = document.getElementById('homelessSimsSection');
            const homelessSimsListDiv = document.getElementById('homelessSimsList');
            homelessSimsListDiv.innerHTML = ''; // Clear homeless list

            const filteredHomeless = simData.homelessSims.members.filter(sim =>
                sim.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                sim.biography.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredHomeless.length > 0 || searchTerm !== '') { // Show section if there are homeless sims or if searching
                homelessSection.classList.remove('hidden');
                filteredHomeless.sort((a, b) => a.name.localeCompare(b.name));
                filteredHomeless.forEach(sim => {
                    const simItem = document.createElement('div');
                    simItem.className = `sim-item px-2 py-1 rounded-md cursor-pointer list-item-hover text-text-primary ${currentSelectedSim && currentSelectedSim.name === sim.name ? 'active' : ''}`;
                    simItem.textContent = sim.name;
                    simItem.onclick = (event) => {
                        event.stopPropagation();
                        selectSim(sim.name);
                    };
                    homelessSimsListDiv.appendChild(simItem);
                });
            } else {
                homelessSection.classList.add('hidden'); // Hide if no homeless sims and no search term
            }
        }


        function toggleFamilyMembers(familyName) {
            const membersListDiv = document.getElementById(`membersList-${familyName}`);
            const expandIcon = document.getElementById(`expandIcon-${familyName}`);

            const isCurrentlyExpanded = membersListDiv.classList.contains('hidden');

            // Collapse any currently active family if different from selected
            if (currentSelectedFamily && currentSelectedFamily !== familyName) {
                const prevMembersList = document.getElementById(`membersList-${currentSelectedFamily}`);
                const prevExpandIcon = document.getElementById(`expandIcon-${currentSelectedFamily}`);
                if (prevMembersList) prevMembersList.classList.add('hidden');
                if (prevExpandIcon) prevExpandIcon.style.transform = 'rotate(0deg)';
            }
            if (currentSelectedFamily !== familyName) {
                // Deselect current sim if changing family view
                currentSelectedSim = null;
            }


            membersListDiv.classList.toggle('hidden');
            if (expandIcon) {
                if (membersListDiv.classList.contains('hidden')) {
                    expandIcon.style.transform = 'rotate(0deg)';
                } else {
                    expandIcon.style.transform = 'rotate(90deg)';
                }
            }

            // Set the current selected family (or null if collapsing the current one)
            currentSelectedFamily = membersListDiv.classList.contains('hidden') ? null : familyName;

            updateFamilyList(); // Re-render to update active states
            if (currentSelectedFamily) { // Only display overview if a family is selected/expanded
                hideAllContentSections();
                displayFamilyOverview(currentSelectedFamily);
            } else {
                // If all families collapsed, go back to welcome screen or stories
                hideAllContentSections();
                document.getElementById('welcomeSection').classList.remove('hidden');
                document.getElementById('contentTitle').textContent = 'Welcome!';
            }
        }

        function toggleHomelessSims() {
            const homelessSimsList = document.getElementById('homelessSimsList');
            const homelessExpandIcon = document.getElementById('homelessExpandIcon');

            homelessSimsList.classList.toggle('hidden');
            if (homelessExpandIcon) {
                if (homelessSimsList.classList.contains('hidden')) {
                    homelessExpandIcon.style.transform = 'rotate(0deg)';
                } else {
                    homelessExpandIcon.style.transform = 'rotate(90deg)';
                }
            }
        }


        function filterFamilyList() {
            const searchBar = document.getElementById('searchBar');
            updateFamilyList(searchBar.value);
            // Also ensure homeless section reflects search
            toggleHomelessSims(); // This will re-evaluate visibility based on current search term
            document.getElementById('homelessExpandIcon').style.transform = 'rotate(90deg)'; // Ensure it's open if search matches
            document.getElementById('homelessSimsList').classList.remove('hidden');
        }

        function findSimByName(simName) {
            for (const familyKey in simData) {
                if (simData[familyKey] && simData[familyKey].members) {
                    const found = simData[familyKey].members.find(sim => sim.name === simName);
                    if (found) return found;
                }
            }
            return null; // Sim not found
        }


        function displayFamilyOverview(familyName) {
            hideAllContentSections();
            const familyOverviewSection = document.getElementById('familyOverviewSection');
            familyOverviewSection.classList.remove('hidden');

            document.getElementById('contentTitle').textContent = `${familyName} Family`;

            const family = simData[familyName];
            document.getElementById('familyOverviewTitle').textContent = `${familyName} Family`;
            document.getElementById('familyOverviewBio').textContent = family.bio || 'No family biography available.';

            const familyMembersList = document.getElementById('familyMembersList');
            familyMembersList.innerHTML = ''; // Clear previous members

            if (family.members) {
                // Sort members alphabetically by name for display
                family.members.sort((a, b) => a.name.localeCompare(b.name));
                family.members.forEach(sim => {
                    const simCard = document.createElement('div');
                    simCard.className = 'sim-card p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow';
                    simCard.onclick = () => selectSim(sim.name);
                    simCard.innerHTML = `
                        <img src="${sim.portrait}" alt="${sim.name}" class="w-24 h-24 rounded-full mx-auto mb-3 object-cover">
                        <h5 class="text-lg font-semibold text-center text-text-primary">${sim.name}</h5>
                        <p class="text-sm text-center text-gray-600 dark:text-gray-400">${sim.occupation || 'Unemployed'}</p>
                    `;
                    familyMembersList.appendChild(simCard);
                });
            }
        }


        function displaySimDetails(sim) {
            hideAllContentSections();
            document.getElementById('simDetailsSection').classList.remove('hidden');
            document.getElementById('contentTitle').textContent = sim.name;

            document.getElementById('simPortrait').src = sim.portrait;
            document.getElementById('simName').textContent = sim.name;
            document.getElementById('simPronouns').textContent = sim.pronouns;
            document.getElementById('simAge').textContent = sim.age;
            document.getElementById('simGender').textContent = sim.gender;
            document.getElementById('simSexuality').textContent = sim.sexuality;
            document.getElementById('simOccupation').textContent = sim.occupation;
            document.getElementById('simAspiration').textContent = sim.aspiration;
            document.getElementById('simTraits').textContent = sim.traits.join(', ') || 'N/A';
            document.getElementById('simSkills').textContent = sim.skills.map(s => `${s.name} (${s.level})`).join(', ') || 'N/A';
            document.getElementById('simBiography').textContent = sim.biography || 'No biography available.';

            const relationshipsList = document.getElementById('simRelationships');
            relationshipsList.innerHTML = '';
            if (sim.relationships && sim.relationships.length > 0) {
                sim.relationships.forEach(rel => {
                    const li = document.createElement('li');
                    li.textContent = rel;
                    relationshipsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No relationships listed.';
                relationshipsList.appendChild(li);
            }

            // Update Skills Chart
            if (simSkillsChartInstance) {
                simSkillsChartInstance.destroy();
            }

            const ctx = document.getElementById('simSkillsChart').getContext('2d');
            const skillNames = sim.skills.map(s => s.name);
            const skillLevels = sim.skills.map(s => s.level);

            simSkillsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: skillNames,
                    datasets: [{
                        label: 'Skill Level',
                        data: skillLevels,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // Tailwind blue-500
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10, // Assuming skills go up to level 10
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary'),
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color'),
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary'),
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color'),
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary'),
                            }
                        }
                    }
                }
            });
        }


        function displayNeighborhoodStories() {
            hideAllContentSections();
            document.getElementById('neighborhoodStoriesSection').classList.remove('hidden');
            document.getElementById('contentTitle').textContent = 'Neighborhood Stories';

            const storiesContainer = document.getElementById('storiesContainer');
            storiesContainer.innerHTML = ''; // Clear previous stories

            if (neighborhoodStories.length === 0) {
                storiesContainer.innerHTML = '<p class="text-text-primary">No neighborhood stories available yet.</p>';
                return;
            }

            // Sort stories by date, newest first (assuming Date is in a sortable format like YYYY-MM-DD)
            neighborhoodStories.sort((a, b) => new Date(b.date) - new Date(a.date));

            neighborhoodStories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card p-4 rounded-lg shadow-md';
                storyCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-text-primary mb-2">${story.title}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${story.date}</p>
                    ${story.image ? `<img src="${story.image}" alt="${story.title}" class="w-full h-48 object-cover rounded-md mb-3">` : ''}
                    <p class="text-text-primary">${story.description}</p>
                `;
                storiesContainer.appendChild(storyCard);
            });
        }


        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            // If a chart exists, update its colors
            if (simSkillsChartInstance) {
                simSkillsChartInstance.options.scales.y.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-primary');
                simSkillsChartInstance.options.scales.x.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-primary');
                simSkillsChartInstance.options.scales.y.grid.color = getComputedStyle(document.body).getPropertyValue('--border-color');
                simSkillsChartInstance.options.scales.x.grid.color = getComputedStyle(document.body).getPropertyValue('--border-color');
                simSkillsChartInstance.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--text-primary');
                simSkillsChartInstance.update();
            }
        }


        // Initial Load of Data
        document.addEventListener('DOMContentLoaded', loadAllData);

        // Add event listener to the welcome section title to go to stories
        document.getElementById('welcomeSection').addEventListener('click', () => {
            displayNeighborhoodStories();
        });

        function selectFamily(familyNameKey) {
            currentSelectedFamily = familyNameKey;
            currentSelectedSim = null; // Deselect any sim when selecting a family
            // Ensure the correct family is expanded and others are collapsed
            for (const key in simData) {
                if (key === "worldInfo") continue;
                const membersList = document.getElementById(`membersList-${key}`);
                const expandIcon = document.getElementById(`expandIcon-${key}`);
                if (membersList && expandIcon) {
                    if (key === familyNameKey) {
                        membersList.classList.remove('hidden');
                        expandIcon.style.transform = 'rotate(90deg)';
                    } else {
                        membersList.classList.add('hidden');
                        expandIcon.style.transform = 'rotate(0deg)';
                    }
                }
            }
            // For homeless sims
            const homelessList = document.getElementById('homelessSimsList');
            const homelessExpandIcon = document.getElementById('homelessExpandIcon');
            if (homelessList && homelessExpandIcon) {
                if (familyNameKey === "homelessSims") {
                    homelessList.classList.remove('hidden');
                    homelessExpandIcon.style.transform = 'rotate(90deg)';
                } else {
                    homelessList.classList.add('hidden');
                    homelessExpandIcon.style.transform = 'rotate(0deg)';
                }
            }
            updateFamilyList();
            hideAllContentSections();
            displayFamilyOverview(familyNameKey);
        }

        function selectSim(simName) {
            let foundSim = findSimByName(simName);

            if (!foundSim) {
                console.error(`Sim with name '${simName}' not found.`);
                hideAllContentSections();
                return;
            }

            currentSelectedSim = foundSim;
            // Find the family key of the selected sim to ensure correct highlighting in the sidebar
            for (const familyKey in simData) {
                if (familyKey === "worldInfo") continue;
                if (familyKey === "homelessSims") {
                    if (simData[familyKey] && simData[familyKey].members.find(s => s.name === simName)) {
                        currentSelectedFamily = "homelessSims"; // Special key for homeless
                        break;
                    }
                } else if (simData[familyKey].members && simData[familyKey].members.find(s => s.name === simName)) {
                    currentSelectedFamily = familyKey;
                    break;
                }
            }

            updateFamilyList(); // Re-render the family list to apply selected states
            hideAllContentSections();
            displaySimDetails(currentSelectedSim);
        }
    </script>
</body>
</html>
